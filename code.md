


---
title: "Replication code for 'Making, Updating, and Querying Causal Models using CausalQueries'"
date: 2025-07-30
author: Till Tietz, Lily Medina, Georgiy Syunyaev, and Macartan Humphreys
format:
  html: 
    toc: true
    toc-depth: 2
---

Generated by `knitr::spin()` from `code.R`.

Note: final section of code for microbenchmarking is slow
## Set up


``` r
library("tidyverse")
```

```
## ── Attaching core tidyverse packages ───────────────────────── tidyverse 2.0.0 ──
## ✔ dplyr     1.1.4     ✔ purrr     1.1.0
## ✔ forcats   1.0.0     ✔ readr     2.1.5
## ✔ ggplot2   3.5.2     ✔ tibble    3.3.0
## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
## ── Conflicts ─────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors
```

``` r
library("CausalQueries")
library("microbenchmark")
library("parallel")
library("future")
library("future.apply")
library("knitr")
library("rstan")
```

```
## Loading required package: StanHeaders
## 
## rstan version 2.32.7 (Stan version 2.32.2)
## 
## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)
## For within-chain threading using `reduce_sum()` or `map_rect()` Stan functions,
## change `threads_per_chain` option:
## rstan_options(threads_per_chain = 1)
## 
## 
## Attaching package: 'rstan'
## 
## The following object is masked from 'package:tidyr':
## 
##     extract
```

``` r
options(kableExtra.latex.load_packages = FALSE)
library("kableExtra")
```

```
## 
## Attaching package: 'kableExtra'
## 
## The following object is masked from 'package:dplyr':
## 
##     group_rows
```

``` r
options(mc.cores = parallel::detectCores())


if (knitr::is_latex_output()) {
  
knitr::knit_hooks$set(source = function(x, options) {


  lines <- unlist(strsplit(x, "\n"))
  prompts <- character(length(lines))
  continuation <- FALSE
  open_brackets <- 0

  for (i in seq_along(lines)) {
    line_trimmed <- trimws(lines[i])

    # Determine if the previous line ends with |> or has unmatched brackets
    if (continuation || open_brackets > 0) {
      prompts[i] <- "+  "
    } else {
      prompts[i] <- "R> "
    }

    # Update brackets count
    open_brackets <- open_brackets +
      stringr::str_count(line_trimmed, "[\\(\\{\\[]") -
      stringr::str_count(line_trimmed, "[\\)\\}\\]]")

    # Check if line ends with pipe operator (|>)
    continuation <- grepl("\\|>\\s*$", line_trimmed)

    # Reset bracket count on empty lines
    if (line_trimmed == "") {
      open_brackets <- 0
      continuation <- FALSE
    }
  }

  # Add exactly two spaces indentation to continuation lines starting with "+"
  formatted_lines <- ifelse(
    prompts == "R> ",
    paste0(prompts, trimws(lines, "left")),
    paste0(prompts, "  ", trimws(lines, "left"))
  )

  paste0("\\begin{CodeInput}\n",
         paste(formatted_lines, collapse = "\n"),
         "\n\\end{CodeInput}\n")
})
}

set.seed(1, "L'Ecuyer-CMRG")
theme_set(theme_bw())

kabble <- function(
    x, 
    align = "c", 
    format = ifelse(knitr::is_html_output(), "html", "latex"), 
    ...) {
  x |>
    knitr::kable(
      format = format,
      digits = 2,
      align = align,
      booktabs = TRUE, 
      linesep = "",
      longtable = TRUE,
      ...) |>
    kableExtra::kable_classic_2(latex_options = c("scale_down"))
}
```


# Motivating example


``` r
data("lipids_data")
lipids_data
```

```
##    event strategy count
## 1 Z0X0Y0      ZXY   158
## 2 Z1X0Y0      ZXY    52
## 3 Z0X1Y0      ZXY     0
## 4 Z1X1Y0      ZXY    23
## 5 Z0X0Y1      ZXY    14
## 6 Z1X0Y1      ZXY    12
## 7 Z0X1Y1      ZXY     0
## 8 Z1X1Y1      ZXY    78
```


# Motivating example


``` r
lipids_model <-  make_model("Z -> X -> Y; X <-> Y") 
```

``` r
lipids_model <- update_model(lipids_model, lipids_data)
```

``` r
lipids_queries <- query_model(lipids_model, queries = list(
  ATE = "Y[X = 1] - Y[X = 0]",
  PoC = "Y[X = 1] - Y[X = 0] :|: X == 0 & Y == 0",
  LATE = "Y[X = 1] - Y[X = 0] :|: X[Z = 1] > X[Z = 0]"),
  using = "posteriors")
```

``` r
lipids_queries |>
  dplyr::select(label, query, given, mean, sd, starts_with("cred")) |>
kabble(align = "c")
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:center;"> label </th>
   <th style="text-align:center;"> query </th>
   <th style="text-align:center;"> given </th>
   <th style="text-align:center;"> mean </th>
   <th style="text-align:center;"> sd </th>
   <th style="text-align:center;"> cred.low </th>
   <th style="text-align:center;"> cred.high </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Y[X = 1] - Y[X = 0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> 0.55 </td>
   <td style="text-align:center;"> 0.10 </td>
   <td style="text-align:center;"> 0.37 </td>
   <td style="text-align:center;"> 0.73 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> PoC </td>
   <td style="text-align:center;"> Y[X = 1] - Y[X = 0] </td>
   <td style="text-align:center;"> X == 0 &amp; Y == 0 </td>
   <td style="text-align:center;"> 0.64 </td>
   <td style="text-align:center;"> 0.15 </td>
   <td style="text-align:center;"> 0.37 </td>
   <td style="text-align:center;"> 0.89 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> LATE </td>
   <td style="text-align:center;"> Y[X = 1] - Y[X = 0] </td>
   <td style="text-align:center;"> X[Z = 1] &gt; X[Z = 0] </td>
   <td style="text-align:center;"> 0.70 </td>
   <td style="text-align:center;"> 0.05 </td>
   <td style="text-align:center;"> 0.59 </td>
   <td style="text-align:center;"> 0.80 </td>
  </tr>
</tbody>
</table>

``` r
lipids_queries |> plot()
```

![Illustration of queries plotted.](figure/queryplot-1.png)



# Statistical model


``` r
with_pars <- 
  lipids_model |>
  set_parameters(param_type = "prior_draw") 

with_pars |> grab("parameters_df") |>
  dplyr::select(node, nodal_type, param_set, param_names, param_value, priors) |> 
  kabble()
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:center;"> node </th>
   <th style="text-align:center;"> nodal_type </th>
   <th style="text-align:center;"> param_set </th>
   <th style="text-align:center;"> param_names </th>
   <th style="text-align:center;"> param_value </th>
   <th style="text-align:center;"> priors </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> Z </td>
   <td style="text-align:center;"> 0 </td>
   <td style="text-align:center;"> Z </td>
   <td style="text-align:center;"> Z.0 </td>
   <td style="text-align:center;"> 0.57 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Z </td>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> Z </td>
   <td style="text-align:center;"> Z.1 </td>
   <td style="text-align:center;"> 0.43 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> 00 </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X.00 </td>
   <td style="text-align:center;"> 0.24 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X.10 </td>
   <td style="text-align:center;"> 0.30 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> 01 </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X.01 </td>
   <td style="text-align:center;"> 0.20 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> 11 </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X.11 </td>
   <td style="text-align:center;"> 0.27 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 00 </td>
   <td style="text-align:center;"> Y.X.00 </td>
   <td style="text-align:center;"> Y.00_X.00 </td>
   <td style="text-align:center;"> 0.71 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> Y.X.00 </td>
   <td style="text-align:center;"> Y.10_X.00 </td>
   <td style="text-align:center;"> 0.19 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 01 </td>
   <td style="text-align:center;"> Y.X.00 </td>
   <td style="text-align:center;"> Y.01_X.00 </td>
   <td style="text-align:center;"> 0.00 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 11 </td>
   <td style="text-align:center;"> Y.X.00 </td>
   <td style="text-align:center;"> Y.11_X.00 </td>
   <td style="text-align:center;"> 0.10 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 00 </td>
   <td style="text-align:center;"> Y.X.01 </td>
   <td style="text-align:center;"> Y.00_X.01 </td>
   <td style="text-align:center;"> 0.15 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> Y.X.01 </td>
   <td style="text-align:center;"> Y.10_X.01 </td>
   <td style="text-align:center;"> 0.40 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 01 </td>
   <td style="text-align:center;"> Y.X.01 </td>
   <td style="text-align:center;"> Y.01_X.01 </td>
   <td style="text-align:center;"> 0.39 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 11 </td>
   <td style="text-align:center;"> Y.X.01 </td>
   <td style="text-align:center;"> Y.11_X.01 </td>
   <td style="text-align:center;"> 0.06 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 00 </td>
   <td style="text-align:center;"> Y.X.10 </td>
   <td style="text-align:center;"> Y.00_X.10 </td>
   <td style="text-align:center;"> 0.17 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> Y.X.10 </td>
   <td style="text-align:center;"> Y.10_X.10 </td>
   <td style="text-align:center;"> 0.65 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 01 </td>
   <td style="text-align:center;"> Y.X.10 </td>
   <td style="text-align:center;"> Y.01_X.10 </td>
   <td style="text-align:center;"> 0.14 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 11 </td>
   <td style="text-align:center;"> Y.X.10 </td>
   <td style="text-align:center;"> Y.11_X.10 </td>
   <td style="text-align:center;"> 0.04 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 00 </td>
   <td style="text-align:center;"> Y.X.11 </td>
   <td style="text-align:center;"> Y.00_X.11 </td>
   <td style="text-align:center;"> 0.24 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> Y.X.11 </td>
   <td style="text-align:center;"> Y.10_X.11 </td>
   <td style="text-align:center;"> 0.71 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 01 </td>
   <td style="text-align:center;"> Y.X.11 </td>
   <td style="text-align:center;"> Y.01_X.11 </td>
   <td style="text-align:center;"> 0.04 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> Y </td>
   <td style="text-align:center;"> 11 </td>
   <td style="text-align:center;"> Y.X.11 </td>
   <td style="text-align:center;"> Y.11_X.11 </td>
   <td style="text-align:center;"> 0.01 </td>
   <td style="text-align:center;"> 1 </td>
  </tr>
</tbody>
</table>


# Making models


``` r
model <- make_model("X -> M -> Y <- X")
```


## Graphing


``` r
lipids_model |> plot()
lipids_model |> plot(x_coord = 1:3, y_coord = 3:1, textcol = "black",
  textsize = 3, shape = c(15, 16, 16), nodecol = "lightgrey", nodesize = 10)
```

<div class="figure">
<img src="figure/fig-plots-1.png" alt="Examples of model graphs." width="50%" /><img src="figure/fig-plots-2.png" alt="Examples of model graphs." width="50%" />
<p class="caption">Examples of model graphs.</p>
</div>


## Tailoring models


``` r
statements <- list("X -> Y <- W", 
                   "X -> Y <- W; X <-> W", 
                   "X -> Y <- W; X <-> Y; W <-> Y",
                   "X -> Y <- W; X <-> Y; W <-> Y; X <-> W", 
                   "X -> W -> Y <- X",
                   "X -> W -> Y <- X; W <-> Y",
                   "X -> W -> Y <- X; X <-> W; W <-> Y", 
                   "X -> W -> Y <- X; X <-> W; W <-> Y; X <-> Y")

dof <- function(statement) {
  make_model(statement, add_causal_types = FALSE) |>
  grab("parameters_df")  |>
  group_by(param_set) |>
  summarize(n  = n() - 1) |>
  pull(n) |>
  sum()
}



data.frame(
  Model = c(
  "X → Y ← W",
  "X → Y ← W; X ←→ W",
  "X → Y ← W; X ←→ Y; W ←→ Y",
  "X → Y ← W; X ←→ Y; W ←→ Y; X ←→ W",
  "X → W → Y ← X",
  "X → W → Y ← X; W ←→ Y",
  "X → W → Y ← X; X ←→ W; W ←→ Y",
  "X → W → Y ← X; X ←→ W; W ←→ Y; X ←→ Y"
),
  dof = unlist(lapply(statements, dof))
) |> 
  kabble(
    col.names = c("Model", "Degrees of freedom"),
    align = c("l", "c")
  )
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:left;"> Model </th>
   <th style="text-align:center;"> Degrees of freedom </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> X → Y ← W </td>
   <td style="text-align:center;"> 17 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → Y ← W; X ←→ W </td>
   <td style="text-align:center;"> 18 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → Y ← W; X ←→ Y; W ←→ Y </td>
   <td style="text-align:center;"> 62 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → Y ← W; X ←→ Y; W ←→ Y; X ←→ W </td>
   <td style="text-align:center;"> 63 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → W → Y ← X </td>
   <td style="text-align:center;"> 19 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → W → Y ← X; W ←→ Y </td>
   <td style="text-align:center;"> 64 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → W → Y ← X; X ←→ W; W ←→ Y </td>
   <td style="text-align:center;"> 67 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> X → W → Y ← X; X ←→ W; W ←→ Y; X ←→ Y </td>
   <td style="text-align:center;"> 127 </td>
  </tr>
</tbody>
</table>

``` r
model_restricted <- lipids_model |> 
  set_restrictions("X[Z = 1] < X[Z = 0]")
```

``` r
model <- lipids_model |> set_restrictions(
  labels = list(X = "01", Y = c("00", "01", "11")), keep = TRUE)
```

``` r
model <- lipids_model |> set_restrictions(labels = list(Y = "?0"))
```

``` r
model <- lipids_model |> set_restrictions(
  labels = list(Y = c('00', '11')), given = 'X.00')
```

``` r
lipids_model |> inspect("prior_hyperparameters", nodes = "X") 
```

```
## 
## prior_hyperparameters
## Alpha parameter values used for Dirichlet prior distributions:
## 
## X.00 X.10 X.01 X.11 
##    1    1    1    1
```

``` r
model <- lipids_model |> set_priors(distribution = "jeffreys")
```

```
## Altering all parameters.
```

``` r
lipids_model |> set_priors(
  param_names = c("X.10", "X.01"), alphas = 3:4) |> 
  inspect("prior_hyperparameters", nodes = "X")
```

```
## 
## prior_hyperparameters
## Alpha parameter values used for Dirichlet prior distributions:
## 
## X.00 X.10 X.01 X.11 
##    1    3    4    1
```

``` r
lipids_model |> set_priors(
  statement = "X[Z = 1] > X[Z = 0]", alphas = 3) |>
  inspect("prior_hyperparameters", nodes = "X")
```

```
## 
## prior_hyperparameters
## Alpha parameter values used for Dirichlet prior distributions:
## 
## X.00 X.10 X.01 X.11 
##    1    1    3    1
```

``` r
query <- make_model("X -> Y") |> 
  set_restrictions(decreasing("X", "Y")) |>
  query_model("Y[X = 1] - Y[X = 0]", using = "priors")
```

``` r
make_model("X -> Y") |> inspect("parameters")
```

```
## 
## parameters
## Model parameters with associated probabilities: 
## 
##  X.0  X.1 Y.00 Y.10 Y.01 Y.11 
## 0.50 0.50 0.25 0.25 0.25 0.25
```

``` r
make_model("X -> Y") |> set_parameters(
  statement = "Y[X = 1] > Y[X = 0]", parameters = .7) |>
  inspect("parameters")
```

```
## 
## parameters
## Model parameters with associated probabilities: 
## 
##  X.0  X.1 Y.00 Y.10 Y.01 Y.11 
##  0.5  0.5  0.1  0.1  0.7  0.1
```


## Drawing and manipulating data


``` r
lipids_model |> make_data(n = 4)
```

```
##   Z X Y
## 1 0 1 1
## 2 1 0 0
## 3 1 1 1
## 4 1 1 1
```

``` r
sample_data <- lipids_model |> make_data(
  n = 8, nodes = list(c("Z", "Y"), "X"), probs = list(1, .5),
  subsets = list(TRUE, "Z == 1 & Y == 0"))
```

``` r
sample_data |> collapse_data(lipids_model)
```

```
##     event strategy count
## 1  Z0X0Y0      ZXY     0
## 2  Z1X0Y0      ZXY     0
## 3  Z0X1Y0      ZXY     0
## 4  Z1X1Y0      ZXY     0
## 5  Z0X0Y1      ZXY     1
## 6  Z1X0Y1      ZXY     0
## 7  Z0X1Y1      ZXY     0
## 8  Z1X1Y1      ZXY     0
## 9    Z0Y0       ZY     2
## 10   Z1Y0       ZY     1
## 11   Z0Y1       ZY     2
## 12   Z1Y1       ZY     2
```


# Updating models



## How the Stan program works


``` r
make_model("X -> Y") |> inspect("parameter_mapping") 
```

```
## 
## parameter_mapping (Parameter mapping matrix) 
## 
##   Maps from parameters to data types, with
##   possibly multiple columns for each data type
##   in cases with confounding. 
## 
##      X0Y0 X1Y0 X0Y1 X1Y1
## X.0     1    0    1    0
## X.1     0    1    0    1
## Y.00    1    1    0    0
## Y.10    0    1    1    0
## Y.01    1    0    0    1
## Y.11    0    0    1    1
```


## Incomplete and censored data


``` r
data <- data.frame(X = rep(0:1, 5), Y = rep(0:1, 5))
list(uncensored = update_model(make_model("X -> Y"), 
  data = data, refresh = 0),
    censored = update_model(make_model("X -> Y"), data = data, 
    censored_types = c("X1Y0",  "X0Y1"), refresh = 0)) |>
  query_model("Y[X = 1] - Y[X = 0]", using = "posteriors") |>
  dplyr::select(-using)
```

```
## 
## Causal queries generated by query_model
## 
## |model      |case_level |  mean|    sd| cred.low| cred.high|
## |:----------|:----------|-----:|-----:|--------:|---------:|
## |uncensored |FALSE      | 0.590| 0.196|    0.145|     0.897|
## |censored   |FALSE      | 0.015| 0.318|   -0.625|     0.641|
```


## Output


``` r
model <- make_model("X -> Y") |> update_model()
posterior <- inspect(model, "posterior_distribution")  
```

```
## 
## posterior_distribution
## Summary statistics of model parameters posterior distributions:
## 
##   Distributions matrix dimensions are 
##   4000 rows (draws) by 6 cols (parameters)
## 
##      mean   sd
## X.0  0.49 0.29
## X.1  0.51 0.29
## Y.00 0.25 0.20
## Y.10 0.26 0.20
## Y.01 0.25 0.19
## Y.11 0.24 0.19
```

``` r
lipids_model <- lipids_model |> update_model(
  keep_fit = TRUE, keep_event_probabilities = TRUE)
```

``` r
make_model("X -> Y") |> update_model(keep_type_distribution = FALSE, 
  refresh = 0) |> inspect("stan_summary") 
```

```
## 
## stan_summary
## Stan model summary:
## 
## Inference for Stan model: simplexes.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                    mean se_mean   sd   2.5%   25%   50%   75% 97.5% n_eff Rhat
## X.0                0.49    0.01 0.29   0.02  0.24  0.49  0.75  0.97  2976 1.00
## X.1                0.51    0.01 0.29   0.03  0.25  0.51  0.76  0.98  2976 1.00
## Y.00               0.25    0.01 0.19   0.01  0.09  0.20  0.37  0.71  1419 1.00
## Y.10               0.25    0.00 0.19   0.01  0.09  0.20  0.37  0.71  4026 1.00
## Y.01               0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.71  4142 1.00
## Y.11               0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.71  4265 1.00
## lp__               1.02    0.02 1.00   0.03  0.29  0.71  1.43  3.75  2419 1.00
## log_sum_gammas[2]  1.86    0.05 1.27   0.34  0.99  1.59  2.42  4.99   649 1.01
## lp__              -7.58    0.05 1.72 -11.74 -8.44 -7.17 -6.34 -5.43  1185 1.00
## 
## Samples were drawn using NUTS(diag_e) at Wed Jul 30 16:25:32 2025.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).
```


## Convergence problems and diagnostics


``` r
model <- make_model("X -> M -> Y") |> update_model(
  data = data.frame(X = rep(0:1, 10000), Y = rep(0:1, 10000)), 
  iter = 5000, refresh = 0)
```

``` r
model
```

```
## 
## Causal statement: 
## M -> Y; X -> M
## 
## Number of nodal types by node:
## X M Y 
## 2 4 4 
## 
## Number of causal types: 32
## 
## Model has been updated and contains a posterior distribution with
## 4 chains, each with iter=5000; warmup=2500; thin=1;  
## Use inspect(model, 'stan_summary') to inspect stan summary
## 
## Warnings passed from rstan during updating:
## The largest R-hat is 1.53, indicating chains have not mixed
## Bulk Effective Samples Size (ESS) is too low
## Tail Effective Samples Size (ESS) is too low
```

``` r
model <- make_model("X -> Y") |> 
  update_model(refresh = 0, keep_fit = TRUE)
```

``` r
model |> inspect("stanfit")
```

```
## 
## stanfit
## Stan model summary:
## Inference for Stan model: simplexes.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                    mean se_mean   sd   2.5%   25%   50%   75% 97.5% n_eff Rhat
## lambdas[1]         0.50    0.01 0.29   0.03  0.25  0.49  0.74  0.97  3036 1.00
## lambdas[2]         0.50    0.01 0.29   0.03  0.26  0.51  0.75  0.97  3036 1.00
## lambdas[3]         0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.70  2031 1.00
## lambdas[4]         0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.71  4633 1.00
## lambdas[5]         0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.72  4162 1.00
## lambdas[6]         0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.71  4701 1.00
## log_sum_gammas[1]  1.00    0.02 0.96   0.03  0.30  0.72  1.39  3.43  2536 1.00
## log_sum_gammas[2]  1.85    0.03 1.19   0.36  1.00  1.58  2.41  4.93  1159 1.01
## types[1]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.50  2065 1.00
## types[2]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.48  2390 1.00
## types[3]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.50  3785 1.00
## types[4]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.49  3407 1.00
## types[5]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.48  3507 1.00
## types[6]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.49  3619 1.00
## types[7]           0.12    0.00 0.13   0.00  0.03  0.08  0.17  0.49  3841 1.00
## types[8]           0.13    0.00 0.13   0.00  0.03  0.08  0.19  0.49  3863 1.00
## lp__              -7.53    0.04 1.65 -11.75 -8.37 -7.15 -6.32 -5.44  1368 1.00
## 
## Samples were drawn using NUTS(diag_e) at Wed Jul 30 16:25:44 2025.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).
```


# Querying models



## Calculating factual and counterfactual quantities


``` r
make_model("X -> Y") |> realise_outcomes()
```

```
##      X Y
## 0.00 0 0
## 1.00 1 0
## 0.10 0 1
## 1.10 1 0
## 0.01 0 0
## 1.01 1 1
## 0.11 0 1
## 1.11 1 1
```

``` r
make_model("X -> Y") |> realise_outcomes(dos = list(X = 1))
```

```
##      X Y
## 0.00 1 0
## 1.00 1 0
## 0.10 1 0
## 1.10 1 0
## 0.01 1 1
## 1.01 1 1
## 0.11 1 1
## 1.11 1 1
```


## Causal syntax


``` r
make_model("X -> Y")  |> get_query_types("Y == 1")
```

```
## 
## Causal types satisfying query's condition(s)  
## 
##  query =  Y==1 
## 
## X0.Y10  X1.Y01
## X0.Y11  X1.Y11
## 
## 
##  Number of causal types that meet condition(s) =  4
##  Total number of causal types in model =  8
```

``` r
make_model("X -> Y") |> get_query_types("Y[X = 0] == 1")
```

```
## 
## Causal types satisfying query's condition(s)  
## 
##  query =  Y[X=0]==1 
## 
## X0.Y10  X1.Y10
## X0.Y11  X1.Y11
## 
## 
##  Number of causal types that meet condition(s) =  4
##  Total number of causal types in model =  8
```

``` r
make_model("X1 -> Y <- X2")  |> get_query_types(
  "X1 == 1 & X2 == 1 & (Y[X1 = 1, X2 = 1] > Y[X1 = 0, X2 = 0])")
```

```
## 
## Causal types satisfying query's condition(s)  
## 
##  query =  X1==1&X2==1&(Y[X1=1,X2=1]>Y[X1=0,X2=0]) 
## 
## X11.X21.Y0001  X11.X21.Y0101
## X11.X21.Y0011  X11.X21.Y0111
## 
## 
##  Number of causal types that meet condition(s) =  4
##  Total number of causal types in model =  64
```

``` r
make_model("X -> Y") |> get_query_types("Y[X = 1] - Y[X = 0]")
```

```
## X0.Y00 X1.Y00 X0.Y10 X1.Y10 X0.Y01 X1.Y01 X0.Y11 X1.Y11 
##      0      0     -1     -1      1      1      0      0
```


## Quantifying queries


``` r
data  <- data.frame(X = rep(0:1, 50), Y = rep(0:1, 50))

model <-  make_model("X -> Y") |> update_model(
  data, iter = 4000, refresh = 0)

model |> grab("posterior_distribution")  |> 
  ggplot(aes(Y.01 - Y.10)) + geom_histogram() 
```

<div class="figure" style="text-align: center">
<img src="figure/fig-posterior-dist-1.png" alt="Posterior on "Probability $Y$ is increasing in $X$"." width="60%" />
<p class="caption">Posterior on "Probability $Y$ is increasing in $X$".</p>
</div>

``` r
queries <- make_model("X -> Y") |> query_distribution(
  query = list(increasing = "(Y[X = 1] > Y[X = 0])", 
    ATE = "(Y[X = 1] - Y[X = 0])"), using = "priors")
```

``` r
lipids_model |> query_model(
    query = "Y[X = 1] - Y[X = 0] :|: X == 1 & Y == 1 & Z == 1",
    using = "posteriors") |> plot()
```

![Illustration of case-level queries plotted.](figure/fig-case-level-query-1.png)

``` r
make_model("X -> M -> Y") |> update_model(
  data.frame(X = rep(0:1, 8), Y = rep(0:1, 8)), iter = 4000, refresh = 0) |>
  query_model("Y[X = 1] > Y[X = 0] :|: X == 1 & Y == 1 & M == 1", 
  using = "posteriors", case_level = c(TRUE, FALSE)) |>
  plot()
```

![Illustration of new case-level queries plotted.](figure/fig-new-case-level-query-1.png)

``` r
models <- list(
  Unrestricted = lipids_model |> 
    update_model(data = lipids_data, refresh = 0),
  Restricted = lipids_model |> set_restrictions("X[Z = 1] < X[Z = 0]") |> 
    update_model(data = lipids_data, refresh = 0)
)
```

``` r
queries <- 
  query_model(
    models, 
     query = list(
       ATE = "Y[X=1] - Y[X=0]", 
       POS = "Y[X=1] > Y[X=0] :|: Y==1 & X==1"),
    case_level = c(FALSE, TRUE), 
    using = c("priors", "posteriors"),
    expand_grid = TRUE)
```

``` r
queries |>
  dplyr::select(-starts_with("cred"), -sd) |> 
  kabble(align = "c") 
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:center;"> label </th>
   <th style="text-align:center;"> model </th>
   <th style="text-align:center;"> query </th>
   <th style="text-align:center;"> given </th>
   <th style="text-align:center;"> using </th>
   <th style="text-align:center;"> case_level </th>
   <th style="text-align:center;"> mean </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.56 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.55 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.50 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.49 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.95 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> FALSE </td>
   <td style="text-align:center;"> 0.95 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.56 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ATE </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] - Y[X=0] </td>
   <td style="text-align:center;"> - </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.55 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.50 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> priors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.49 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Unrestricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.95 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> POS </td>
   <td style="text-align:center;"> Restricted </td>
   <td style="text-align:center;"> Y[X=1] &gt; Y[X=0] </td>
   <td style="text-align:center;"> Y==1 &amp; X==1 </td>
   <td style="text-align:center;"> posteriors </td>
   <td style="text-align:center;"> TRUE </td>
   <td style="text-align:center;"> 0.95 </td>
  </tr>
</tbody>
</table>


default plot associated with this query:


``` r
queries |> plot()
```

![Default plotting for a a set of queries over multiple models.](figure/fig-batch-1.png)


# Appendix A: Parallelization


``` r
library("parallel")
options(mc.cores = parallel::detectCores())
```

``` r
library("future")
library("future.apply")

chains <- 3
cores <- 8

future::plan(list(
  future::tweak(future::multisession, 
    workers = floor(cores/(chains + 1))),
  future::tweak(future::multisession, workers = chains)))

model <- make_model("X -> Y")

data <- list(data_1 = data.frame(X = 0:1, Y = 0:1), 
  data_2 = data.frame(X = 0:1, Y = 1:0))

results <- future.apply::future_lapply(data, function(d) {
  update_model(model = model, data = d, chains = chains, refresh = 0)},
 future.seed = TRUE)
```


# Appendix B: Stan code


``` r
CausalQueries:::stanmodels$simplexes
```

```
## S4 class stanmodel 'simplexes' coded as follows:
## functions {
##   row_vector col_sums(matrix X) {
##     row_vector[cols(X)] s;
##     s = rep_row_vector(1, rows(X)) * X;
##     return s;
##   }
## }
## data {
##   int<lower=1> n_params;
##   int<lower=1> n_paths;
##   int<lower=1> n_types;
##   int<lower=1> n_param_sets;
##   int<lower=1> n_nodes;
##   array[n_param_sets] int<lower=1> n_param_each;
##   int<lower=1> n_data;
##   int<lower=1> n_events;
##   int<lower=1> n_strategies;
##   int<lower=0, upper=1> keep_type_distribution;
##   vector<lower=0>[n_params] lambdas_prior;
##   array[n_param_sets] int<lower=1> l_starts;
##   array[n_param_sets] int<lower=1> l_ends;
##   array[n_nodes] int<lower=1> node_starts;
##   array[n_nodes] int<lower=1> node_ends;
##   array[n_strategies] int<lower=1> strategy_starts;
##   array[n_strategies] int<lower=1> strategy_ends;
##   matrix[n_params, n_types] P;
##   matrix[n_params, n_paths] parmap;
##   matrix[n_paths, n_data] map;
##   matrix<lower=0, upper=1>[n_events, n_data] E;
##   array[n_events] int<lower=0> Y;
## }
## parameters {
##   vector<lower=0>[n_params - n_param_sets] gamma;
## }
## transformed parameters {
##   vector<lower=0, upper=1>[n_params] lambdas;
##   vector<lower=1>[n_param_sets] sum_gammas;
##   matrix[n_params, n_paths] parlam;
##   matrix[n_nodes, n_paths] parlam2;
##   vector<lower=0, upper=1>[n_paths] w_0;
##   vector<lower=0, upper=1>[n_data] w;
##   vector<lower=0, upper=1>[n_events] w_full;
##   vector[n_param_sets] log_sum_gammas;
##   // Handle cases where parameter set has only one value
##   for (i in 1:n_param_sets) {
##     if (l_starts[i] >= l_ends[i]) {
##       sum_gammas[i] = 1;
##       lambdas[l_starts[i]] = 1;
##     } else {
##       sum_gammas[i] = 1 + sum(gamma[(l_starts[i] - (i - 1)):(l_ends[i] - i)]);
##       lambdas[l_starts[i]:l_ends[i]] =
##         append_row(1, gamma[(l_starts[i] - (i - 1)):(l_ends[i] - i)]) /
##         sum_gammas[i];
##     }
##   }
##   // Mapping from parameters to data types
##   parlam = rep_matrix(lambdas, n_paths) .* parmap;
##   // Sum probability over nodes on each path
##   for (i in 1:n_nodes) {
##     parlam2[i, ] = col_sums(parlam[(node_starts[i]):(node_ends[i]), ]);
##   }
##   // Compute probability of data type on each path
##   for (i in 1:n_paths) {
##     w_0[i] = exp(sum(log(parlam2[, i])));
##   }
##   // Map to n_data columns instead of n_paths (if confounding)
##   w = map' * w_0;
##   // Extend/reduce to cover all observed data types
##   w_full = E * w;
##   // Calculate log sum gammas once for efficiency
##   log_sum_gammas = log(sum_gammas);
## }
## model {
##   // Dirichlet distributions
##   for (i in 1:n_param_sets) {
##     target += dirichlet_lpdf(lambdas[l_starts[i]:l_ends[i]] |
##                              lambdas_prior[l_starts[i]:l_ends[i]]);
##     target += -n_param_each[i] * log_sum_gammas[i];
##   }
##   // Multinomial likelihoods (handling censoring)
##   for (i in 1:n_strategies) {
##     target += multinomial_lpmf(
##       Y[strategy_starts[i]:strategy_ends[i]] |
##       w_full[strategy_starts[i]:strategy_ends[i]] /
##       sum(w_full[strategy_starts[i]:strategy_ends[i]])
##     );
##   }
## }
## // Option to export distribution of causal types
## generated quantities {
##   vector[n_types] types;
##   if (keep_type_distribution == 1) {
##     for (i in 1:n_types) {
##       types[i] = prod(P[, i] .* lambdas + 1 - P[, i]);
##     }
##   } else {
##     types = rep_vector(1, n_types);
##   }
## }
```


# Appendix C: Benchmarks


``` r
iter  <- 4000
times <- 5

model <- list(
  CausalQueries::make_model("X -> Y"),
  CausalQueries::make_model("X1 -> Y <- X2"),
  CausalQueries::make_model("X1 -> Y; X2 -> Y; X3 -> Y")
)

data <- expand_grid(X1 = 0:1, X2 = 0:1, X3 = 0:1) |> uncount(20) |>
  mutate(Y = 1 * (X1 - X2 * X3 + rnorm(n()) > 0))


benchmark_model <- microbenchmark::microbenchmark(
  m1 = CausalQueries::update_model(model[[1]], data, iter = iter, refresh = 0),
  m2 = CausalQueries::update_model(model[[2]], data, iter = iter, refresh = 0),
  m3 = CausalQueries::update_model(model[[3]], data, iter = iter, refresh = 0),
  times = times
)
```

```
## Warning: The largest R-hat is 1.18, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

```
## Warning: The largest R-hat is 1.13, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

```
## Warning: The largest R-hat is 1.05, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

```
## Warning: The largest R-hat is 1.07, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

```
## Warning: The largest R-hat is 1.07, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

``` r
benchmark_1 <- data.frame(
Model = c(
  "X1 → Y",
  "X1 → Y; X2 → Y",
  "X1 → Y; X2 → Y; X3 → Y"
  ),
  x = c(6, 20, 262),
  t = (benchmark_model |> summary() |> pull(mean))) 

benchmark_1 |> 
 kabble(col.names = c("Model", "Number of parameters", "Runtime (seconds)"), align = "c")  
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:center;"> Model </th>
   <th style="text-align:center;"> Number of parameters </th>
   <th style="text-align:center;"> Runtime (seconds) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> X1 → Y </td>
   <td style="text-align:center;"> 6 </td>
   <td style="text-align:center;"> 5.32 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X1 → Y; X2 → Y </td>
   <td style="text-align:center;"> 20 </td>
   <td style="text-align:center;"> 6.59 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X1 → Y; X2 → Y; X3 → Y </td>
   <td style="text-align:center;"> 262 </td>
   <td style="text-align:center;"> 54.48 </td>
  </tr>
</tbody>
</table>

``` r
model <- CausalQueries::make_model("X -> Y")

data <- lapply(10^c(1:4), function(n) {
  CausalQueries::make_data(model, n)
})

benchmark_data <- microbenchmark::microbenchmark(
  d0 = CausalQueries::update_model(model, data[[1]], iter = iter, refresh = 0),
  d1 = CausalQueries::update_model(model, data[[2]], iter = iter, refresh = 0),
  d2 = CausalQueries::update_model(model, data[[3]], iter = iter, refresh = 0),
  d3 = CausalQueries::update_model(model, data[[4]], iter = iter, refresh = 0),
  times = times
)
```

```
## Warning: There were 221 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.
```

```
## Warning: Examine the pairs() plot to diagnose sampling problems
```

```
## Warning: The largest R-hat is 1.1, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

```
## Warning: There were 6 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.
```

```
## Warning: Examine the pairs() plot to diagnose sampling problems
```

```
## Warning: There were 46 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.
```

```
## Warning: Examine the pairs() plot to diagnose sampling problems
```

```
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess
```

```
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess
```

``` r
benchmark2 <- data.frame(
  Model = c("X1 → Y", 
            "X1 → Y", 
            "X1 → Y", 
            "X1 → Y"),
  x = c(10, 100,  1000, 10000),
  t = (benchmark_data |> summary() |> pull(mean))
) 

benchmark2 |>
 kabble(col.names = c("Model", "Number of observations", "Runtime (seconds)"), align = "c")
```

<table class=" lightable-classic-2" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; margin-left: auto; margin-right: auto;'>
 <thead>
  <tr>
   <th style="text-align:center;"> Model </th>
   <th style="text-align:center;"> Number of observations </th>
   <th style="text-align:center;"> Runtime (seconds) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> X1 → Y </td>
   <td style="text-align:center;"> 10 </td>
   <td style="text-align:center;"> 5.09 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X1 → Y </td>
   <td style="text-align:center;"> 100 </td>
   <td style="text-align:center;"> 5.19 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X1 → Y </td>
   <td style="text-align:center;"> 1000 </td>
   <td style="text-align:center;"> 5.88 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> X1 → Y </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;"> 7.82 </td>
  </tr>
</tbody>
</table>

