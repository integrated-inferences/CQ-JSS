<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Till Tietz">
<meta name="author" content="Lily Medina">
<meta name="author" content="Georgiy Syunyaev">
<meta name="author" content="Macartan Humphreys">

<title>Making, Updating, and Querying Causal Models with CausalQueries</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="2_paper_files/libs/clipboard/clipboard.min.js"></script>
<script src="2_paper_files/libs/quarto-html/quarto.js"></script>
<script src="2_paper_files/libs/quarto-html/popper.min.js"></script>
<script src="2_paper_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2_paper_files/libs/quarto-html/anchor.min.js"></script>
<link href="2_paper_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2_paper_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2_paper_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2_paper_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2_paper_files/libs/bootstrap/bootstrap-8ffaf084027a881f3b7580f5d96998cb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="2_paper_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="2_paper_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="2_paper.pdf"><i class="bi bi-file-pdf"></i>PDF (jss)</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Making, Updating, and Querying Causal Models with <span class="pkg">CausalQueries</span></h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://github.com/till-tietz">Till Tietz</a> <a href="mailto:ttietz2014@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-2916-9059" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Independent Researcher
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://lilymedina.github.io/">Lily Medina</a> <a href="mailto:lily.medina@berkeley.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0009-0004-2423-524X" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of California, Berkeley
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://gsyunyaev.com/">Georgiy Syunyaev</a> <a href="mailto:g.syunyaev@vanderbilt.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-4391-6313" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Vanderbilt University
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://macartan.github.io/">Macartan Humphreys</a> <a href="mailto:macartan.humphreys@wzb.eu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0001-7029-2326" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            WZB
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    The <span class="proglang">R</span> package <span class="pkg">CausalQueries</span> can be used to make, update, and query causal models defined on binary nodes. Users provide a causal statement of the form <code>X -&gt; M &lt;- Y; M &lt;-&gt; Y</code> which is interpreted as a structural causal model over a collection of binary nodes. Then <span class="pkg">CausalQueries</span> allows users to (1) identify the set of principal strata—causal types—required to characterize all possible causal relations between nodes that are consistent with the causal statement (2) determine a set of parameters needed to characterize distributions over these causal types (3) update beliefs over distributions of causal types, using a <code>stan</code> model plus data, and (4) pose a wide range of causal queries of the model, using either the prior distribution, the posterior distribution, or a user-specified candidate vector of parameters.
  </div>
</div>


</header>


<section id="sec-intro" class="level2">
<h2 class="anchored" data-anchor-id="sec-intro">Introduction: Causal models</h2>
<p><span class="pkg">CausalQueries</span> is an <span class="proglang">R</span> package that lets users make, update, and query causal models. Users provide a structural causal model in the form of a statement that reports a set of binary variables and the relations of causal ancestry between them. There are three primary functions. The first, <code>make_model()</code>, takes a causal statement and generates a parameter vector that fully describes a probability distribution over all possible types of causal relations between variables (“causal types”). Given a prior distribution over parameters—equivalently, over causal models consistent with the structural model— and data on some or all nodes, the second primary function, <code>update_model()</code>, deploys a Stan <span class="citation" data-cites="carpenter_stan_2017">(<a href="#ref-carpenter_stan_2017" role="doc-biblioref">Carpenter et al. 2017</a>)</span> model to generate a posterior distribution over causal models. The third primary function <code>query_model()</code> can then be used to ask a wide range of causal queries, using either the prior distribution, the posterior distribution, or a user-specified candidate vector of parameters.</p>
<p>In the next section we provide a motivating example that uses the three primary functions together. We then describe how the package relates to existing available software. <a href="#sec-theory" class="quarto-xref">Section&nbsp;4</a> gives an overview of the statistical model behind the package. <a href="#sec-make" class="quarto-xref">Section&nbsp;6</a>, <a href="#sec-update" class="quarto-xref">Section&nbsp;7</a>, and <a href="#sec-query" class="quarto-xref">Section&nbsp;8</a> then describe, in turn, the functionality for making, updating, and querying causal models. We provide further computation details in the final section.</p>
</section>
<section id="motivating-example" class="level2">
<h2 class="anchored" data-anchor-id="motivating-example">Motivating example</h2>
<p>Before providing details on package functionality, we give an example of an application of the three primary functions, showing how to use <span class="pkg">CausalQueries</span> to replicate the analysis in <span class="citation" data-cites="chickering_clinicians_1996 humphreys_integrated_2023">(<a href="#ref-chickering_clinicians_1996" role="doc-biblioref">Chickering and Pearl 1996</a>; see also <a href="#ref-humphreys_integrated_2023" role="doc-biblioref">Humphreys and Jacobs 2023</a>)</span>.</p>
<p><span class="citation" data-cites="chickering_clinicians_1996">Chickering and Pearl (<a href="#ref-chickering_clinicians_1996" role="doc-biblioref">1996</a>)</span> seek to draw inferences on causal effects in the presence of imperfect compliance. We have access to an instrument <span class="math inline">\(Z\)</span> (a randomly assigned prescription for cholesterol medication), which is a cause of <span class="math inline">\(X\)</span> (treatment uptake) but otherwise unrelated to <span class="math inline">\(Y\)</span> (cholesterol). We imagine we are interested in three specific queries. The first is the average causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. The second is the average effect for units for which <span class="math inline">\(X=0\)</span> and <span class="math inline">\(Y=0\)</span>; this “probability of causation” query asks whether untreated individuals with bad outcomes did poorly <em>because</em> they were untreated. The last is the average effect for “compliers”: units for which <span class="math inline">\(X\)</span> responds positively to <span class="math inline">\(Z\)</span>. Thus two of these queries are conditional queries, with one conditional on a counterfactual quantity.</p>
<p>The data on <span class="math inline">\(Z\)</span>, <span class="math inline">\(X\)</span>, and <span class="math inline">\(Y\)</span> is given in <span class="citation" data-cites="chickering_clinicians_1996">Chickering and Pearl (<a href="#ref-chickering_clinicians_1996" role="doc-biblioref">1996</a>)</span> and is also included in the <span class="pkg">CausalQueries</span> package. The data looks as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"lipids_data"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lipids_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   event strategy count
1 Z0X0Y0      ZXY   158
2 Z1X0Y0      ZXY    52
3 Z0X1Y0      ZXY     0
4 Z1X1Y0      ZXY    23
5 Z0X0Y1      ZXY    14
6 Z1X0Y1      ZXY    12
7 Z0X1Y1      ZXY     0
8 Z1X1Y1      ZXY    78</code></pre>
</div>
</div>
<p>This data is reported in “compact form,” meaning it records the number of units (“count”) that display each possible pattern of outcomes on <span class="math inline">\(Z\)</span>, <span class="math inline">\(X\)</span>, and <span class="math inline">\(Y\)</span> (“event”).</p>
<p>The strategy to analyse this data involves three steps:</p>
<ul>
<li>Step 1: generate a model with <code>make_model</code>, yielding an object of class <code>causal_model</code>,</li>
<li>Step 2: update the model with <code>update_model</code>, again yielding an object of class <code>causal_model</code>,</li>
<li>Step 3: pose queries of the model with <code>query_model</code>, yielding an object of class <code>model_query</code>.</li>
</ul>
<p>Users generate the stipulated causal model using <span class="pkg">CausalQueries</span> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="ot">&lt;-</span>  <span class="fu">make_model</span>(<span class="st">"Z -&gt; X -&gt; Y; X &lt;-&gt; Y"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is an object of class <code>causal_model</code>, with associated <code>print</code>, <code>summary</code>, and <code>plot</code> methods. By default, uniform priors are placed on model parameters.</p>
<p>Users can then <em>update</em> beliefs over model parameters by supplying data as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="ot">&lt;-</span> <span class="fu">update_model</span>(lipids_model, lipids_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The updated model is also an object of class <code>causal_model</code>, though now also containing a posterior distribution over model parameters.</p>
<p>Finally, users can <em>query</em> the model. For instance, the three previously mentioned queries, which vary in the type of conditioning imposed, can be formulated as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>lipids_queries <span class="ot">&lt;-</span> <span class="fu">query_model</span>(lipids_model, <span class="at">queries =</span> <span class="fu">list</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ATE =</span> <span class="st">"Y[X = 1] - Y[X = 0]"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">PoC =</span> <span class="st">"Y[X = 1] - Y[X = 0] :|: X == 0 &amp; Y == 0"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">LATE =</span> <span class="st">"Y[X = 1] - Y[X = 0] :|: X[Z = 1] &gt; X[Z = 0]"</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">using =</span> <span class="st">"posteriors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output is an object of class <code>model_query</code>, with associated <code>print</code>, <code>summary</code>, and <code>plot</code> methods.</p>
<p>The <code>model_query</code> object is a data frame containing estimates, and, when available, prior or posterior standard deviations, and credibility intervals.</p>
<p><a href="#tbl-lipids" class="quarto-xref">Table&nbsp;1</a> presents the results from the analysis of the lipids data.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Rows 1 and 2 in the table replicate the results from <span class="citation" data-cites="chickering_clinicians_1996">Chickering and Pearl (<a href="#ref-chickering_clinicians_1996" role="doc-biblioref">1996</a>)</span>, while row 3 provides inferences for the local average treatment effects (LATE).</p>
<div class="cell">
<div id="tbl-lipids" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-lipids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Replication of .
</figcaption>
<div aria-describedby="tbl-lipids-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">label</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">query</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">given</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">mean</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">cred.low</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">cred.high</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Y[X = 1] - Y[X = 0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">0.55</td>
<td style="text-align: center;">0.10</td>
<td style="text-align: center;">0.37</td>
<td style="text-align: center;">0.73</td>
</tr>
<tr class="even">
<td style="text-align: center;">PoC</td>
<td style="text-align: center;">Y[X = 1] - Y[X = 0]</td>
<td style="text-align: center;">X == 0 &amp; Y == 0</td>
<td style="text-align: center;">0.63</td>
<td style="text-align: center;">0.15</td>
<td style="text-align: center;">0.38</td>
<td style="text-align: center;">0.89</td>
</tr>
<tr class="odd">
<td style="text-align: center;">LATE</td>
<td style="text-align: center;">Y[X = 1] - Y[X = 0]</td>
<td style="text-align: center;">X[Z = 1] &gt; X[Z = 0]</td>
<td style="text-align: center;">0.70</td>
<td style="text-align: center;">0.05</td>
<td style="text-align: center;">0.59</td>
<td style="text-align: center;">0.80</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>For visual presentation of the results, output can also be plotted:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lipids_queries <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2_paper_files/figure-html/queryplot-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Illustration of queries plotted.</figcaption>
</figure>
</div>
</div>
</div>
<p>These core functions can be combined in a single pipeline as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"Z -&gt; X -&gt; Y; X &lt;-&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>(lipids_data) <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query_model</span>(<span class="at">queries =</span> <span class="fu">list</span>(<span class="at">ATE =</span> <span class="st">"Y[X = 1] - Y[X = 0]"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">PoC  =</span> <span class="st">"Y[X = 1] - Y[X = 0] :|: X == 0 &amp; Y == 0"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">LATE =</span> <span class="st">"Y[X = 1] - Y[X = 0] :|: X[Z = 1] &gt; X[Z = 0]"</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">using =</span> <span class="st">"posteriors"</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we describe below, the same basic procedure of making, updating, and querying models, can be used (up to computational constraints) for arbitrary causal models, for different types of data structures, and for all causal queries that can be posed of the causal model.</p>
</section>
<section id="connections-to-existing-packages" class="level2">
<h2 class="anchored" data-anchor-id="connections-to-existing-packages">Connections to existing packages</h2>
<p>The field of causal inference encompasses a wide range of software tools used across social sciences, natural sciences, computer science, and applied mathematics. This section focuses on the role and capabilities of <span class="pkg">CausalQueries</span> specifically for evaluating causal queries on models represented as directed acyclic graphs (DAGs). <a href="#tbl-software" class="quarto-xref">Table&nbsp;2</a> provides a summary of relevant software, highlighting their strengths and limitations in comparison to <span class="pkg">CausalQueries</span>.</p>
<div id="tbl-software" class="quarto-float quarto-figure quarto-figure-center anchored" data-tbl-colwidths="[19,20,10,18,38]">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-software-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Related software.
</figcaption>
<div aria-describedby="tbl-software-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 19%">
<col style="width: 10%">
<col style="width: 17%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Software</th>
<th>Source</th>
<th>Language</th>
<th>Availability</th>
<th>Scope</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="pkg">causalnex</span></td>
<td><span class="citation" data-cites="beaumont_causalnex_2021">Beaumont et al. (<a href="#ref-beaumont_causalnex_2021" role="doc-biblioref">2021</a>)</span></td>
<td><span class="proglang">Python</span></td>
<td><ul>
<li>pip</li>
</ul></td>
<td><ul>
<li>causal structure learning</li>
<li>querying marginal distributions</li>
<li>discrete data</li>
</ul></td>
</tr>
<tr class="even">
<td><span class="pkg">pclag</span></td>
<td><span class="citation" data-cites="kalisch_causal_2012">Kalisch et al. (<a href="#ref-kalisch_causal_2012" role="doc-biblioref">2012</a>)</span></td>
<td><span class="proglang">R</span></td>
<td><ul>
<li>CRAN</li>
<li>GitHub</li>
</ul></td>
<td><ul>
<li>causal structure learning</li>
<li>ATEs under linear conditional expectations, no hidden selection</li>
</ul></td>
</tr>
<tr class="odd">
<td><span class="pkg">DoWhy</span></td>
<td><span class="citation" data-cites="dowhy">Sharma and Kiciman (<a href="#ref-dowhy" role="doc-biblioref">2020</a>)</span></td>
<td><span class="proglang">Python</span></td>
<td><ul>
<li>pip</li>
</ul></td>
<td><ul>
<li>identification</li>
<li>average and conditional causal effects</li>
<li>robustness checks</li>
</ul></td>
</tr>
<tr class="even">
<td><span class="pkg">autobounds</span></td>
<td><span class="citation" data-cites="duarte_automated_2023">Duarte et al. (<a href="#ref-duarte_automated_2023" role="doc-biblioref">2023</a>)</span></td>
<td><span class="proglang">Python</span></td>
<td><ul>
<li>Docker</li>
<li>GitHub</li>
</ul></td>
<td><ul>
<li>bounding causal effects</li>
<li>partial identification</li>
<li>DAG canonicalization</li>
<li>binary data</li>
</ul></td>
</tr>
<tr class="odd">
<td><span class="pkg">causaloptim</span></td>
<td><span class="citation" data-cites="sachs_general_2023">Sachs et al. (<a href="#ref-sachs_general_2023" role="doc-biblioref">2023</a>)</span></td>
<td><span class="proglang">R</span></td>
<td><ul>
<li>CRAN</li>
<li>GitHub</li>
</ul></td>
<td><ul>
<li>bounding causal effects</li>
<li>non-identified queries</li>
<li>binary data</li>
</ul></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p><span class="pkg">causalnex</span> is comprehensive software that offers functions for discovering and querying causal models. Like <span class="pkg">CausalQueries</span>, it uses Bayesian methods and supports “<code>do</code> calculus” <span class="citation" data-cites="pearl_causality_2009">(<a href="#ref-pearl_causality_2009" role="doc-biblioref">Pearl 2009</a>)</span>. It focuses on conditional probability distribution tables instead of principal strata (causal types). This limits the types of queries and expert information that can be incorporated. For example, knowing conditional probability distributions is not enough to make claims about (or provide priors with respect to) effect monotonicity, complier effects, or the “probability of causation” <span class="citation" data-cites="dawid2017probability">(<a href="#ref-dawid2017probability" role="doc-biblioref">Dawid, Musio, and Murtas 2017</a>)</span>. However, it allows for efficient handling of simple queries with larger models.</p>
<p>Similar to <span class="pkg">causalnex</span>, <span class="pkg">pclag</span> emphasizes learning about causal structures and uses the resulting DAGs to recover average treatment effects (ATEs) across all learned Markov-equivalent classes from observed data that satisfy linearity of conditional expectations. This approach is also more restrictive than <span class="pkg">CausalQueries</span> in terms of the queries it allows.</p>
<p><span class="pkg">DoWhy</span> is a feature-rich framework focusing on causal identification, effect estimation, and assumption validation. With a user-specified DAG, it uses do-calculus to find expressions that identify desired causal effects through Back-door, Front-door, instrumental variable (IV), and mediation criteria, and then uses standard estimators to estimate the desired effect. After estimation, <span class="pkg">DoWhy</span> deploys a comprehensive refutation engine with a large set of robustness tests. While this approach efficiently handles varied data types on large causal models, not parameterizing the DAG itself limits the types of queries that can be posed.</p>
<p>The packages most similar to <span class="pkg">CausalQueries</span> for model definition are <span class="pkg">autobounds</span> and <span class="pkg">causaloptim</span>. They deal with discrete causal models, and their definitions of principal strata (causal types) and causal relations on the DAG are very similar to those of <span class="pkg">CausalQueries</span>. Differences arise in how disturbance terms and confounding are defined: implicitly by the causal statement in <span class="pkg">CausalQueries</span> versus explicitly via separate disturbance nodes in <span class="pkg">autobounds</span> and <span class="pkg">causaloptim</span>. While <span class="pkg">CausalQueries</span> assumes a canonical form for input DAGs, <span class="pkg">autobounds</span> and <span class="pkg">causaloptim</span> facilitate canonicalization. The main difference between the methods is in their approach to evaluating queries.</p>
<p>Both <span class="pkg">autobounds</span> and <span class="pkg">causaloptim</span> build on seminal approaches in <span class="citation" data-cites="balke_bounds_1997">Balke and Pearl (<a href="#ref-balke_bounds_1997" role="doc-biblioref">1997</a>)</span> to construct bounds on queries, using constrained polynomial and linear optimization, respectively. In contrast, <span class="pkg">CausalQueries</span> uses Bayesian inference to generate a posterior over the causal model, which is then queried <span class="citation" data-cites="chickering_clinicians_1996 zhang_partial_2022">(consistent with <a href="#ref-chickering_clinicians_1996" role="doc-biblioref">Chickering and Pearl 1996</a>; <a href="#ref-zhang_partial_2022" role="doc-biblioref">Zhang, Tian, and Bareinboim 2022</a>)</span>. A key difference is the target of inference. The polynomial and linear programming approach is suited to handling larger causal models. However, due to their similar model parameterization, <span class="pkg">autobounds</span>, <span class="pkg">causaloptim</span>, and <span class="pkg">CausalQueries</span> face similar constraints as parameter spaces expand rapidly with model size. The Bayesian approach to model updating and querying is more efficient because a model can be updated once and queried multiple times, while expensive optimization runs are needed for each separate query in <span class="pkg">autobounds</span> and <span class="pkg">causaloptim</span>.</p>
<p>In summary, the main strength of <span class="pkg">CausalQueries</span> is its ability to let users define an arbitrary DAG and pose any queries on it, using a canonical procedure to form Bayesian posteriors for those queries, regardless of whether they are identified. For instance, if researchers want to learn about the local average treatment effect and their model meets the conditions in <span class="citation" data-cites="angrist_identification_1996">Angrist, Imbens, and Rubin (<a href="#ref-angrist_identification_1996" role="doc-biblioref">1996</a>)</span>, updating will recover valid estimates as data grows, even if researchers are unaware that the local average treatment effect is identified or unfamiliar with the specific estimation method proposed by <span class="citation" data-cites="angrist_identification_1996">Angrist, Imbens, and Rubin (<a href="#ref-angrist_identification_1996" role="doc-biblioref">1996</a>)</span>.</p>
<p>There are two main limitations of the models that <span class="pkg">CausalQueries</span> can handle. First, <span class="pkg">CausalQueries</span> is designed for models with a relatively small number of binary nodes. Since it does not limit the range of possible causal relationships in a model, the parameter space expands quickly with the model’s complexity. This complexity growth depends on the causal structure and increases rapidly with the number of parents influencing a child node. A chain model like <span class="math inline">\(A \rightarrow B \rightarrow C \rightarrow D \rightarrow E\)</span> has only 18 parameters (<span class="math inline">\(2^1 + 4\times 2^2\)</span>), while a model in which <span class="math inline">\(A, B, C, D\)</span> are all direct ancestors of <span class="math inline">\(E\)</span> has <span class="math inline">\(65,544\)</span> parameters (<span class="math inline">\(4\times 2^1 + 2^{(2^4)}\)</span>). Switching from binary to nonbinary nodes has similar effects. The restriction to binary nodes is for computational, not conceptual, reasons.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Second, the package is designed for learning about populations from independently sampled units. Therefore, it does not inherently address issues of clustering, hierarchical structures, or purposive sampling. However, the broader framework can be adapted for these purposes <span class="citation" data-cites="humphreys_integrated_2023">(see Section 9.4 of <a href="#ref-humphreys_integrated_2023" role="doc-biblioref">Humphreys and Jacobs 2023</a>)</span>. The targets of inference are case-level or population-level quantities; <span class="pkg">CausalQueries</span> is not well-suited for estimating sample quantities.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="sec-theory" class="level2">
<h2 class="anchored" data-anchor-id="sec-theory">Statistical model</h2>
<p>The core conceptual framework used by <span class="pkg">CausalQueries</span> is that described in Pearl’s <em>Causality</em> <span class="citation" data-cites="pearl_causality_2009">(<a href="#ref-pearl_causality_2009" role="doc-biblioref">Pearl 2009</a>)</span>.</p>
<p>The two key steps to defining a causal model are to define a causal structure and then place a probability distribution over the exogeneous variables in the model.</p>
<p>Relying on ideas in <span class="citation" data-cites="pearl_causality_2009 humphreys_integrated_2023">Pearl (<a href="#ref-pearl_causality_2009" role="doc-biblioref">2009</a>; with notation from <a href="#ref-humphreys_integrated_2023" role="doc-biblioref">Humphreys and Jacobs 2023</a>)</span>, we define a causal model as follows:</p>
<p>Elements 1-3 define a “<strong>structural causal model</strong>.” These components pin down a causal structure, specifying which endogenous nodes are (possible) direct causes of a node, <span class="math inline">\(Y_j\)</span>, given the other nodes in a model. Such nodes are referred to as the “parents” of <span class="math inline">\(Y_j\)</span>, denoted as <span class="math inline">\(PA_j\)</span> (where uppercase <span class="math inline">\(PA_j\)</span> represents the collection of nodes, and lowercase <span class="math inline">\(pa_j\)</span> represents a specific set of values these nodes might assume).</p>
<p>Specifying a structural causal model involves making possibly strong assumptions, for example about which nodes are not plausibly causes of other nodes. Even still, without information on the distribution of exogenous nodes, a structural causal model is generally not rich enough to allow us to make probabilistic statements about the distribution of outcomes. Adding the final element of the definition then gives us the fully specified causal model.</p>
<p>With discrete-valued nodes, it is possible to identify all potential responses of a node to possible values of its parents, which we call the set of “nodal types” (“response functions” in <span class="citation" data-cites="pearl_causality_2009">Pearl (<a href="#ref-pearl_causality_2009" role="doc-biblioref">2009</a>)</span>). If a node <span class="math inline">\(i\)</span> can take on <span class="math inline">\(k_i\)</span> possible values, then the set of possible values that the parents of <span class="math inline">\(j\)</span> can assume is <span class="math inline">\(m_j :=\prod_{i\in PA_j}k_i\)</span>. Consequently, there are <span class="math inline">\(k_j^{m_j}\)</span> different ways that node <span class="math inline">\(j\)</span> might respond to its parents. For binary nodes, this simplifies to <span class="math inline">\(2^{\left(2^{|PA_j|}\right)}\)</span>. Thus, an endogenous node with no parents has 2 nodal types; a binary node with one binary parent has four types; and a binary node with two parents has 16 types, and so forth.</p>
<p>As a practical matter we need to label response types. In <span class="pkg">CausalQueries</span> this is done using subscripts that indicate the response given different combinations of parents. A node, <span class="math inline">\(Y\)</span>, with one binary parent, <span class="math inline">\(X\)</span>, has nodal types subscripted with two values indicating the two possible values of <span class="math inline">\(Y\)</span>’s parent (<span class="math inline">\(0\)</span> or <span class="math inline">\(1\)</span>): <span class="math inline">\((\theta_{00}, \theta_{01}, \theta_{10}, \theta_{11})\)</span>, where <span class="math inline">\(\theta_{ab}\)</span> denotes a nodal type for which <span class="math inline">\(Y\)</span> takes the value <span class="math inline">\(a\)</span> under the intervention <span class="math inline">\(\text{do}(X = 0)\)</span> and the value <span class="math inline">\(b\)</span> under <span class="math inline">\(\text{do}(X = 1)\)</span>. The same approach is used for nodes with more (or fewer) nodal types, where the <span class="math inline">\(i\)</span>th digit in the subscript corresponds to the value the node takes when the parents take on the <span class="math inline">\(i\)</span>th combination of possible parent values (listed in colexicographic binary order given the specified ordering of parents).<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>The complete set of possible causal reactions of a given unit to all possible values of its parents is represented by its collection of nodal types at each node. We refer to this collection as a unit’s “causal type,” denoted as <span class="math inline">\(\theta\)</span>. These causal types correspond to the principal strata, which are familiar from the study of instrumental variables <span class="citation" data-cites="frangakis_principal_2002">(<a href="#ref-frangakis_principal_2002" role="doc-biblioref">Frangakis and Rubin 2002</a>)</span>.</p>
<p><span class="pkg">CausalQueries</span> treats the set of nodal types of <span class="math inline">\(Y_j\)</span> as the domain of exogenous nodes <span class="math inline">\(\theta^{Y_j}\)</span>. The function <span class="math inline">\(f_{Y_j}\)</span> then determines the value of <span class="math inline">\(y\)</span> by simply reporting the value of <span class="math inline">\(Y_j\)</span> implied by the nodal type and the values of the parents of <span class="math inline">\(Y_j\)</span>. Therefore, if <span class="math inline">\(\theta^{Y_j}_{pa_j}\)</span> is the value for <span class="math inline">\(j\)</span> when parents have values <span class="math inline">\(pa_j\)</span>, then <span class="math inline">\(f_{Y_j}(\theta^{j}, pa_j) = \theta^{Y_j}_{pa_j}\)</span>. Practically, this means that, given the causal structure, learning about the model reduces to learning about the distribution, <span class="math inline">\(\lambda\)</span>, over the nodal types.</p>
<p>In scenarios without unobserved confounding, we assume that the probability distributions over the nodal types for different nodes are independent: <span class="math inline">\(\theta^i \perp\!\!\! \perp \theta^{Y_j}, i\neq j\)</span>. In this case, we use a categorical distribution to specify <span class="math inline">\({\lambda^j_x} := \Pr(\theta^{Y_j} = {\theta^{Y_j}_x})\)</span>. From this independence, the probability of a given causal type <span class="math inline">\(\theta_x\)</span> is <span class="math inline">\(\prod_{i=1}^n {\lambda^i_x}\)</span>. For example, <span class="math inline">\(\Pr(\theta = (\theta^X_1, \theta^Y_{01})) = \Pr(\theta^X = \theta^X_1)\Pr(\theta^Y = \theta^Y_{01}) = \lambda^X_1\lambda^Y_{01}\)</span>. In cases where confounding is present, the logic remains the same, but we need to specify enough parameters to capture the joint distribution over nodal types for different nodes.</p>
<p>For instance, in the Lipids model, the joint distribution of nodal types can be simplified as shown in <a href="#eq-join" class="quarto-xref">Equation&nbsp;1</a>.</p>
<p><span id="eq-join"><span class="math display">\[
\Pr(\theta^Z = \theta^Z_1, \theta^X = \theta^X_{10}, \theta^Y = \theta^Y_{11}) =
\Pr(\theta^Z = \theta^Z_1)\Pr(\theta^X = \theta^X_{10})\Pr(\theta^Y = \theta^Y_{11}|\theta^X = \theta^X_{10})
\tag{1}\]</span></span></p>
<p>And so, for this model, <span class="math inline">\(\lambda\)</span> would include parameters that represent <span class="math inline">\(\Pr(\theta^Z)\)</span> and <span class="math inline">\(\Pr(\theta^X)\)</span> but also the conditional probability <span class="math inline">\(\Pr(\theta^Y|\theta^X)\)</span>:</p>
<p><span id="eq-join2"><span class="math display">\[
\Pr(\theta^Z = \theta^Z_1, \theta^X = \theta^X_{10}, \theta^Y = \theta^Y_{11}) =
\lambda^Z_1\lambda^X_{10}\lambda^{Y|\theta^X_{10}}_{11}
\tag{2}\]</span></span></p>
<p>Representing beliefs <em>over causal models</em> (in contrast to beliefs over causal types given a causal model) thus requires specifying a probability distribution over <span class="math inline">\(\lambda\)</span> itself. This distribution might be degenerate if users wish to specify a particular model. <span class="pkg">CausalQueries</span> also allows users to specify parameters, <span class="math inline">\(\alpha\)</span>, of a Dirichlet distribution over <span class="math inline">\(\lambda^j\)</span> for each node <span class="math inline">\(Y^j\)</span> (and similarly for conditional distributions in cases of confounding). If all entries of <span class="math inline">\(\alpha\)</span> are <span class="math inline">\(0.5\)</span>, this corresponds to Jeffreys priors. By default, <span class="pkg">CausalQueries</span> assumes a uniform distribution, meaning all nodal types are equally likely, which corresponds to <span class="math inline">\(\alpha\)</span> being a vector of <span class="math inline">\(1\)</span>’s.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>Updating is then done with respect to beliefs over <span class="math inline">\(\lambda\)</span>. In the Bayesian approach we have:</p>
<p><span class="math display">\[
p(\lambda|D) = \frac{p(D|\lambda)p(\lambda)}{\int_{\lambda^{'}} p(D|\lambda')p(\lambda')}
\]</span></p>
<p>where <span class="math inline">\(p(D|\lambda')\)</span> is calculated under the assumption that units are exchangeable and independently drawn. In practice this means that the probability that two units have causal types <span class="math inline">\(\theta'_i\)</span> and <span class="math inline">\(\theta'_j\)</span> is simply <span class="math inline">\(\lambda'_i\lambda'_j\)</span>. Since a causal type fully determines an outcome vector <span class="math inline">\(d = \{y_1, y_2,\dots,y_n\}\)</span>, the probability of a given outcome (“event”), <span class="math inline">\(w_d\)</span>, is given simply by the probability that the causal type is among those that yield outcome <span class="math inline">\(d\)</span>. Thus, from <span class="math inline">\(\lambda\)</span> we can calculate a vector of event probabilities, <span class="math inline">\(w(\lambda)\)</span>, for each vector of outcomes. For <span class="math inline">\(N\)</span> units, and assuming independence, the probability of observing a set of outcomes at all nodes across all units is:</p>
<p><span class="math display">\[
D \sim \text{Multinomial}(w(\lambda), N)
\]</span></p>
<p>Thus for instance in the case of an <span class="math inline">\(X \rightarrow Y\)</span> model, letting <span class="math inline">\(w_{xy}\)</span> denote the probability of a data type <span class="math inline">\(X=x, Y=y\)</span>, the event probabilities are:</p>
<p><span class="math display">\[
w(\lambda) = \left\{\begin{array}{ccc} w_{00} &amp; = &amp; \lambda^X_0(\lambda^Y_{00} + \lambda^Y_{01})\\
w_{01} &amp; = &amp; \lambda^X_0(\lambda^Y_{11} + \lambda^Y_{10})\\
w_{10} &amp; = &amp; \lambda^X_1(\lambda^Y_{00} + \lambda^Y_{10})\\
w_{11} &amp; = &amp; \lambda^X_1(\lambda^Y_{11} + \lambda^Y_{01})\end{array} \right.
\]</span></p>
<p>where <span class="math inline">\(\lambda^Y_{01}=\Pr(\theta^Y = \theta^Y_{01})\)</span> and the subscripts (<span class="math inline">\(0\)</span>, <span class="math inline">\(00\)</span>, <span class="math inline">\(01\)</span>, ) summarize the responses of nodes to parent combinations, as described above.</p>
<p>For a more complex example, <a href="#tbl-lipidspar" class="quarto-xref">Table&nbsp;3</a> illustrates key values for the Lipids model. We see here that we have two types for the exogenous node <span class="math inline">\(Z\)</span>, four for <span class="math inline">\(X\)</span> (representing the strata familiar from instrumental variables analysis: never takers, always takers, defiers, and compliers) and four for <span class="math inline">\(Y\)</span>. For <span class="math inline">\(Z\)</span> and <span class="math inline">\(X\)</span> we have parameters corresponding to the probability of these nodal types. For instance <code>Z.0</code> is the probability that <span class="math inline">\(Z=0\)</span>. <code>Z.1</code> is the complementary probability that <span class="math inline">\(Z=1\)</span>. Things are a little more complicated for distributions on nodal types for <span class="math inline">\(Y\)</span> however: because of confounding between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> we have parameters that capture the conditional probability of the nodal types for <span class="math inline">\(Y\)</span> <em>given</em> the nodal types for <span class="math inline">\(X\)</span>. We see there are four sets of these parameters. The next to final column shows a sample set of parameter values. Together, the parameters describe a full joint probability distribution over types for <span class="math inline">\(Z\)</span>, <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> that is faithful to the graph.</p>
<div class="cell">
<div id="tbl-lipidspar" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-lipidspar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Nodal types and parameters for Lipids model.
</figcaption>
<div aria-describedby="tbl-lipidspar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">node</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">nodal_type</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">param_set</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">param_names</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">param_value</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">priors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Z</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">Z.0</td>
<td style="text-align: center;">0.57</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Z</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">Z.1</td>
<td style="text-align: center;">0.43</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X</td>
<td style="text-align: center;">00</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X.00</td>
<td style="text-align: center;">0.24</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">X</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X.10</td>
<td style="text-align: center;">0.30</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X</td>
<td style="text-align: center;">01</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X.01</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">X</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">X</td>
<td style="text-align: center;">X.11</td>
<td style="text-align: center;">0.27</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">00</td>
<td style="text-align: center;">Y.X.00</td>
<td style="text-align: center;">Y.00_X.00</td>
<td style="text-align: center;">0.71</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">Y.X.00</td>
<td style="text-align: center;">Y.10_X.00</td>
<td style="text-align: center;">0.19</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">01</td>
<td style="text-align: center;">Y.X.00</td>
<td style="text-align: center;">Y.01_X.00</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">Y.X.00</td>
<td style="text-align: center;">Y.11_X.00</td>
<td style="text-align: center;">0.10</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">00</td>
<td style="text-align: center;">Y.X.01</td>
<td style="text-align: center;">Y.00_X.01</td>
<td style="text-align: center;">0.15</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">Y.X.01</td>
<td style="text-align: center;">Y.10_X.01</td>
<td style="text-align: center;">0.40</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">01</td>
<td style="text-align: center;">Y.X.01</td>
<td style="text-align: center;">Y.01_X.01</td>
<td style="text-align: center;">0.39</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">Y.X.01</td>
<td style="text-align: center;">Y.11_X.01</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">00</td>
<td style="text-align: center;">Y.X.10</td>
<td style="text-align: center;">Y.00_X.10</td>
<td style="text-align: center;">0.17</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">Y.X.10</td>
<td style="text-align: center;">Y.10_X.10</td>
<td style="text-align: center;">0.65</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">01</td>
<td style="text-align: center;">Y.X.10</td>
<td style="text-align: center;">Y.01_X.10</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">Y.X.10</td>
<td style="text-align: center;">Y.11_X.10</td>
<td style="text-align: center;">0.04</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">00</td>
<td style="text-align: center;">Y.X.11</td>
<td style="text-align: center;">Y.00_X.11</td>
<td style="text-align: center;">0.24</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">Y.X.11</td>
<td style="text-align: center;">Y.10_X.11</td>
<td style="text-align: center;">0.71</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">01</td>
<td style="text-align: center;">Y.X.11</td>
<td style="text-align: center;">Y.01_X.11</td>
<td style="text-align: center;">0.04</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">Y</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">Y.X.11</td>
<td style="text-align: center;">Y.11_X.11</td>
<td style="text-align: center;">0.01</td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p>These parameters again imply a probability distribution over data types. For instance the probability of data type <span class="math inline">\(Z=0, X=0, Y=0\)</span> is:</p>
<p><span class="math display">\[
w_{000}=\Pr(Z=0, X=0, Y=0) = \lambda^Z_0\lambda^X_{00}(\lambda^{Y|\lambda^X_{00}}_{00}+\lambda^{Y|\lambda^X_{00}}_{01}) + \lambda^Z_0\lambda^X_{01}(\lambda^{Y|\lambda^X_{01}}_{00}+\lambda^{Y|\lambda^X_{01}}_{01})
\]</span></p>
<p>The value of the <span class="pkg">CausalQueries</span> package is that it enables users to specify arbitrary models of this form, determine all the implied nodal and causal types, place priors over these models, and update over these models using given priors and data. This is achieved by calculating event probabilities based on all possible parameter vectors and subsequently the likelihood of the data given the model. Additionally, the package allows users to pose arbitrary queries on a model to evaluate the values of estimands of interest, which are functions of the values or counterfactual values of nodes, <em>conditional</em> on the values or counterfactual values of nodes.</p>
<p>The following sections review the classes and methods used by <span class="pkg">CausalQueries</span> and the key functionalities for making, updating, and querying causal models.</p>
</section>
<section id="sec-classes" class="level2">
<h2 class="anchored" data-anchor-id="sec-classes">Classes and methods</h2>
<p><span class="pkg">CausalQueries</span> makes use of two types of object classes, <code>causal_model</code> and <code>model_query</code>.</p>
<p>An object of class <code>causal_model</code> encodes a structural causal model and stores information on parameter values—either provided by the user or set to defaults—as well as prior or posterior distributions over model parameters. An object of class <code>causal_model</code> is generated using <code>make_model()</code> and can be adjusted using <code>update_model()</code> as well as a set of helper functions: <code>set_confound</code>, <code>set_restrictions</code>, <code>set_priors</code>, as describe in <a href="#sec-make" class="quarto-xref">Section&nbsp;6</a> and <a href="#sec-update" class="quarto-xref">Section&nbsp;7</a> below. Methods <code>print</code>, <code>summary</code> and <code>plot</code> are available for an object of class <code>causal_model</code>.</p>
<p>An object of class <code>model_query</code> records responses to queries posed of a causal model. Depending on the nature of the query, it can include estimates of effects, prior or posterior standard deviations, and confidence intervals. An object of class <code>causal_model</code> is generated using <code>query_model</code> as described in <a href="#sec-query" class="quarto-xref">Section&nbsp;8</a>. Methods <code>print</code>, <code>summary</code> and <code>plot</code> are available for an object of class <code>model_query</code>.</p>
</section>
<section id="sec-make" class="level2">
<h2 class="anchored" data-anchor-id="sec-make">Making models</h2>
<p>A model can be defined in a single step in <span class="pkg">CausalQueries</span> by supplying a causal statement—expressed using <code>dagitty</code>-style syntax <span class="citation" data-cites="textor_robust_2016">(<a href="#ref-textor_robust_2016" role="doc-biblioref">Textor et al. 2016</a>)</span>— to <code>make_model</code>. This generates an object of class <code>causal_model</code> (see <a href="#sec-classes" class="quarto-xref">Section&nbsp;5</a>).</p>
<p>To illustrate, a model where <span class="math inline">\(X\)</span> causes both <span class="math inline">\(M\)</span> and <span class="math inline">\(Y\)</span>, and <span class="math inline">\(M\)</span> also causes <span class="math inline">\(Y\)</span>, can be created as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; M -&gt; Y &lt;- X"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The statement provides the names of nodes as well as arrows (“<code>-&gt;</code>” or “<code>&lt;-</code>”) connecting nodes and indicating whether one node is a potential cause of another, i.e., whether a given node is a “parent” or “child” of another. Formally, a statement like this is interpreted as:</p>
<ol type="1">
<li><p>Functional equations:</p>
<ul>
<li><span class="math inline">\(Y = f_Y(M, X, \theta^Y)\)</span>,</li>
<li><span class="math inline">\(M = f_M(X, \theta^M)\)</span>,</li>
<li><span class="math inline">\(X = f_X(\theta^X)\)</span>.</li>
</ul></li>
<li><p>Distributions on <span class="math inline">\(\Theta\)</span>:</p>
<ul>
<li><span class="math inline">\(\Pr(\theta^i = \theta^i_k) = \lambda^i_k\)</span>.</li>
</ul></li>
<li><p>Independence assumptions:</p>
<ul>
<li><span class="math inline">\(\theta_i \perp\!\!\! \perp \theta_j, i\neq j\)</span>.</li>
</ul></li>
</ol>
<p>In addition, as we did in the <span class="citation" data-cites="chickering_clinicians_1996">Chickering and Pearl (<a href="#ref-chickering_clinicians_1996" role="doc-biblioref">1996</a>)</span> example, it is possible to use two-headed arrows (“<code>&lt;-&gt;</code>”) to indicate “unobserved confounding,” that is, the presence of an unobserved variable that might influence two or more observed variables. In this case, condition 3 above is relaxed, and the exogenous nodes associated with confounded variables have a joint distribution. We describe how this is done in greater detail in <a href="#sec-confounding" class="quarto-xref">Section&nbsp;6.3.1</a>.</p>
<section id="graphing" class="level3">
<h3 class="anchored" data-anchor-id="graphing">Graphing</h3>
<p>Plotting the model can help users verify that they have correctly defined its structure. <span class="pkg">CausalQueries</span> offers straightforward graphing tools that utilize features from the <code>ggplot2</code> and <code>ggdag</code> packages. Once a model is defined, it can be graphed by calling the <code>plot()</code> method on objects of class <code>causal_model</code>. This method is a wrapper for the <code>plot_model()</code> function and accepts additional options, which are detailed in <code>?plot_model</code>.</p>
<p><a href="#fig-plots" class="quarto-xref">Figure&nbsp;1</a> shows figures generated by plotting <code>lipids_model</code> with and without options. The plots have class <code>c("gg", "ggplot")</code> and so will accept any additional layers available for the objects of class <code>ggplot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">x_coord =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">y_coord =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">1</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">textcol =</span> <span class="st">"black"</span>, <span class="at">textsize =</span> <span class="dv">3</span>, <span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">16</span>), </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">nodecol =</span> <span class="st">"lightgrey"</span>, <span class="at">nodesize =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-plots" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-plots" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-plots-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-plots-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-plots-1.png" class="img-fluid figure-img" style="width:50.0%" data-ref-parent="fig-plots">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-plots-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Without options
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-plots" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-plots-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-plots-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-plots-2.png" class="img-fluid figure-img" style="width:50.0%" data-ref-parent="fig-plots">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-plots-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) With options
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plots-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Examples of model graphs.
</figcaption>
</figure>
</div>
</section>
<section id="model-inspection" class="level3">
<h3 class="anchored" data-anchor-id="model-inspection">Model inspection</h3>
<p>When a model is defined, <span class="pkg">CausalQueries</span> generates a set of internal objects used for all inferential tasks. These include default parameter values, default priors, and matrices that map parameters to causal types and causal types to data types. Although users generally do not need to examine these objects, <span class="pkg">CausalQueries</span> provides two functions, <code>inspect()</code> and <code>grab()</code>, that allow users to quickly review these elements. The only difference between the two is that <code>grab()</code> is quiet and does not produce a printout, whereas <code>inspect()</code> does.</p>
<p><a href="#tbl-core" class="quarto-xref">Table&nbsp;4</a> summarizes features of a causal model that can be examined using <code>inspect()</code>.</p>
<div id="tbl-core" class="quarto-float quarto-figure quarto-figure-center anchored" data-tbl-colwidths="[40,60]">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-core-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Elements of a model that can be inspected.
</figcaption>
<div aria-describedby="tbl-core-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>statement</code></td>
<td>A character string describing causal relations using dagitty syntax.</td>
</tr>
<tr class="even">
<td><code>nodes</code></td>
<td>A list containing the nodes in the model.</td>
</tr>
<tr class="odd">
<td><code>parents_df</code></td>
<td>A table listing nodes, whether they are root nodes or not, and the number and names of parents they have.</td>
</tr>
<tr class="even">
<td><code>parameters</code></td>
<td>A vector of ‘true’ parameters.</td>
</tr>
<tr class="odd">
<td><code>parameter_names</code></td>
<td>A vector of names of parameters.</td>
</tr>
<tr class="even">
<td><code>parameter_mapping</code></td>
<td>A matrix mapping from parameters into data types.</td>
</tr>
<tr class="odd">
<td><code>parameter_matrix</code></td>
<td>A matrix mapping from parameters into causal types.</td>
</tr>
<tr class="even">
<td><code>parameters_df</code></td>
<td>A data frame containing parameter information.</td>
</tr>
<tr class="odd">
<td><code>causal_types</code></td>
<td>A data frame listing causal types and the nodal types that produce them.</td>
</tr>
<tr class="even">
<td><code>nodal_types</code></td>
<td>A list with the nodal types of the model.</td>
</tr>
<tr class="odd">
<td><code>data_types</code></td>
<td>A list with all data types consistent with the model.</td>
</tr>
<tr class="even">
<td><code>ambiguities_matrix</code></td>
<td>A matrix mapping from causal types into data types.</td>
</tr>
<tr class="odd">
<td><code>prior_hyperparameters</code></td>
<td>A vector of alpha values used to parameterize Dirichlet prior distributions; optionally provide node names to reduce output.</td>
</tr>
<tr class="even">
<td><code>prior_distribution</code></td>
<td>A data frame of the parameter prior distribution.</td>
</tr>
<tr class="odd">
<td><code>posterior_distribution</code></td>
<td>A data frame of the parameter posterior distribution.</td>
</tr>
<tr class="even">
<td><code>type_prior</code></td>
<td>A matrix of type probabilities using priors.</td>
</tr>
<tr class="odd">
<td><code>type_posterior</code></td>
<td>A matrix of type probabilities using posteriors.</td>
</tr>
<tr class="even">
<td><code>prior_event_probabilities</code></td>
<td>A vector of data (event) probabilities given a single realization of parameters.</td>
</tr>
<tr class="odd">
<td><code>posterior_event_probabilities</code></td>
<td>A sample of data (event) probabilities from the posterior.</td>
</tr>
<tr class="even">
<td><code>data</code></td>
<td>A data frame with data that was provided to update the model.</td>
</tr>
<tr class="odd">
<td><code>stan_summary</code></td>
<td>A <code>stanfit</code> summary with processed parameter names.</td>
</tr>
<tr class="even">
<td><code>stanfit</code></td>
<td>An unprocessed <code>stanfit</code> object as generated by Stan.</td>
</tr>
<tr class="odd">
<td><code>stan_warnings</code></td>
<td>A list of warnings produced by Stan during updating.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="tailoring-models" class="level3">
<h3 class="anchored" data-anchor-id="tailoring-models">Tailoring models</h3>
<p>When a causal statement is provided to <code>make_model()</code>, the model is created with a set of default assumptions: specifically, there are no restrictions on nodal types, and flat priors are assumed over all parameters. These features can be modified after the model is created using <code>set_confounds</code>, <code>set_restrictions</code>, <code>set_priors</code>, and <code>set_parameters</code>.</p>
<section id="sec-confounding" class="level4">
<h4 class="anchored" data-anchor-id="sec-confounding">Allowing confounding</h4>
<p>Unobserved confounding between two (or more) nodes arises when the nodal types for the nodes are not independent. For instance, in the <span class="math inline">\(X \rightarrow Y\)</span> graph, there are <span class="math inline">\(2\)</span> nodal types for <span class="math inline">\(X\)</span> and <span class="math inline">\(4\)</span> for <span class="math inline">\(Y\)</span>. There are thus <span class="math inline">\(8\)</span> joint nodal types (or causal types), as shown in <a href="#tbl-joint" class="quarto-xref">Table&nbsp;5</a>.</p>
<div id="tbl-joint" class="quarto-float quarto-figure quarto-figure-center anchored" data-tbl-colwidths="[25,25,25,25]">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-joint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Nodal types in an <span class="math inline">\(X \rightarrow Y\)</span> model.
</figcaption>
<div aria-describedby="tbl-joint-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;"><span class="math inline">\(\theta^X_{0}\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\theta^X_{1}\)</span></th>
<th style="text-align: center;"><span class="math inline">\(\sum\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\theta^Y_{00}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_0, \theta^Y_{00})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_1, \theta^Y_{00})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^Y_{00})\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\theta^Y_{10}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_0, \theta^Y_{10})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_1, \theta^Y_{10})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^Y_{10})\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\theta^Y_{01}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_0, \theta^Y_{01})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_1, \theta^Y_{01})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^Y_{01})\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\theta^Y_{11}\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_0, \theta^Y_{11})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_1, \theta^Y_{11})\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^Y_{11})\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\sum\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_0)\)</span></td>
<td style="text-align: center;"><span class="math inline">\(\Pr(\theta^X_1)\)</span></td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p><a href="#tbl-joint" class="quarto-xref">Table&nbsp;5</a> has eight interior elements so that an unconstrained joint distribution would have seven degrees of freedom. A no-confounding assumption means that <span class="math inline">\(\Pr(\theta^X, \theta^Y) = \Pr(\theta^X)\Pr(\theta^Y)\)</span>. In this case, it is sufficient to put a distribution on the marginals, and there would be <span class="math inline">\(3\)</span> degrees of freedom for <span class="math inline">\(Y\)</span> and <span class="math inline">\(1\)</span> for <span class="math inline">\(X\)</span>, totaling <span class="math inline">\(4\)</span> rather than <span class="math inline">\(7\)</span>. To allow for an unconstrained joint distribution, the parameters data frame for this model would include two parameter families associated with the node <span class="math inline">\(Y\)</span>. Each family represents the conditional distribution of <span class="math inline">\(Y\)</span>’s nodal types, given <span class="math inline">\(X\)</span>. For example, the parameter <code>Y01_X.1</code> can be interpreted as <span class="math inline">\(\Pr(\theta^Y = \theta^Y_{01} | \theta^X=1)\)</span>. Refer to <a href="#tbl-lipidspar" class="quarto-xref">Table&nbsp;3</a> for an example of a parameter matrix with confounding.</p>
<p>The confounding structure can influence the number of parameters based on the underlying DAG. <a href="#tbl-dof" class="quarto-xref">Table&nbsp;6</a> demonstrates the number of independent parameters required for different types of confounding.</p>
<div class="cell" data-tbl-pos="b">
<div id="tbl-dof" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-pos="b">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-dof-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Number of different independent parameters (degrees of freedom) for different three-node models.
</figcaption>
<div aria-describedby="tbl-dof-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Degrees of freedom</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">X → Y ← W</td>
<td style="text-align: center;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">X → Y ← W; X ←→ W</td>
<td style="text-align: center;">18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">X → Y ← W; X ←→ Y; W ←→ Y</td>
<td style="text-align: center;">62</td>
</tr>
<tr class="even">
<td style="text-align: left;">X → Y ← W; X ←→ Y; W ←→ Y; X ←→ W</td>
<td style="text-align: center;">63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">X → W → Y ← X</td>
<td style="text-align: center;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">X → W → Y ← X; W ←→ Y</td>
<td style="text-align: center;">64</td>
</tr>
<tr class="odd">
<td style="text-align: left;">X → W → Y ← X; X ←→ W; W ←→ Y</td>
<td style="text-align: center;">67</td>
</tr>
<tr class="even">
<td style="text-align: left;">X → W → Y ← X; X ←→ W; W ←→ Y; X ←→ Y</td>
<td style="text-align: center;">127</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
</section>
<section id="restrictions" class="level4">
<h4 class="anchored" data-anchor-id="restrictions">Setting restrictions</h4>
<p>It is often beneficial to constrain the set of types. In <span class="pkg">CausalQueries</span>, this is achieved at the nodal type level, with restrictions on causal types following those on nodal types. For example, in analyses of data with imperfect compliance, such as in our Lipids model example, it is common to impose a monotonicity assumption: that <span class="math inline">\(X\)</span> does not decrease in response to <span class="math inline">\(Z\)</span>. This assumption is necessary to interpret instrumental variable estimates as consistent estimates of the complier average treatment effect. In <span class="pkg">CausalQueries</span>, we can impose this assumption by removing types for which <span class="math inline">\(X\)</span> decreases in <span class="math inline">\(Z\)</span> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model_restricted <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_restrictions</span>(<span class="st">"X[Z = 1] &lt; X[Z = 0]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we wanted to retain only this nodal type rather than remove it, we could do so by passing <code>keep = TRUE</code> as an argument to the <code>set_restrictions()</code> function call. Users can use <code>inspect(model, "parameter_matrix")</code> to view the resulting parameter matrix in which both the set of parameters and the set of causal types are restricted.</p>
<p>Restrictions in <span class="pkg">CausalQueries</span> can be set in several other ways described below.</p>
<ul>
<li><p>Using nodal type labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">set_restrictions</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">list</span>(<span class="at">X =</span> <span class="st">"01"</span>, <span class="at">Y =</span> <span class="fu">c</span>(<span class="st">"00"</span>, <span class="st">"01"</span>, <span class="st">"11"</span>)), <span class="at">keep =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Using wildcards in nodal type labels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">set_restrictions</span>(<span class="at">labels =</span> <span class="fu">list</span>(<span class="at">Y =</span> <span class="st">"?0"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>In models with confounding, restrictions can be added to nodal types conditional on the values of other nodal types using a <code>given</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">set_restrictions</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">list</span>(<span class="at">Y =</span> <span class="fu">c</span>(<span class="st">'00'</span>, <span class="st">'11'</span>)), <span class="at">given =</span> <span class="st">'X.00'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
<p>Setting restrictions sometimes involves using causal syntax (see <a href="#sec-syntax" class="quarto-xref">Section&nbsp;8.2</a> for a guide to the syntax used by <span class="pkg">CausalQueries</span>). The help file in <code>?set_restrictions</code> provides further details and examples of restrictions users can set.</p>
</section>
<section id="priors" class="level4">
<h4 class="anchored" data-anchor-id="priors">Setting priors</h4>
<p>Priors on model parameters can be added to the parameters data frame and interpreted as alpha parameters of a Dirichlet distribution. The Dirichlet distribution is a probability distribution over an <span class="math inline">\(n-1\)</span> dimensional unit simplex. It is a generalization of the Beta distribution and is parameterized by an <span class="math inline">\(n\)</span>-dimensional positive vector <span class="math inline">\(\alpha\)</span>. For example, a Dirichlet distribution with <span class="math inline">\(\alpha = (1, 1, 1, 1, 1)\)</span> provides a probability distribution over all non-negative <span class="math inline">\(5\)</span>-dimensional vectors that sum to <span class="math inline">\(1\)</span>, such as <span class="math inline">\((0.1, 0.1, 0.1, 0.1, 0.6)\)</span> or <span class="math inline">\((0.1, 0.2, 0.3, 0.3, 0.1)\)</span>. This specific value for <span class="math inline">\(\alpha\)</span> implies that all such vectors are equally likely. Different values for <span class="math inline">\(\alpha\)</span> can be used to adjust the expectation and certainty for each dimension. For instance, the vector <span class="math inline">\(\alpha = (100, 1, 1, 1, 100)\)</span> would place more weight on distributions that are close to <span class="math inline">\((0.5, 0, 0, 0, 0.5)\)</span>.</p>
<p>In <span class="pkg">CausalQueries</span>, priors are generally specified over the distribution of nodal types.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> For example, in a model represented by <span class="math inline">\(X \rightarrow Y\)</span>, there is one Dirichlet distribution over the two types for <span class="math inline">\(\theta^X\)</span> and another Dirichlet distribution over the four types for <span class="math inline">\(\theta^Y\)</span>. Importantly, it is implicitly assumed that priors are independent across families. Thus, in a model represented by <span class="math inline">\(X \rightarrow Y\)</span>, we specify beliefs over <span class="math inline">\(\lambda^X\)</span> and <span class="math inline">\(\lambda^Y\)</span> separately. <span class="pkg">CausalQueries</span> does not allow users to specify correlated beliefs over these parameters.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<p>Prior hyperparameters are set to unity by default, corresponding to uniform priors. Users can retrieve the model’s priors as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">inspect</span>(<span class="st">"prior_hyperparameters"</span>, <span class="at">nodes =</span> <span class="st">"X"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
prior_hyperparameters
Alpha parameter values used for Dirichlet prior distributions:

X.00 X.10 X.01 X.11 
   1    1    1    1 </code></pre>
</div>
</div>
<p>Alternatively users can set Jeffreys priors using <code>set_priors()</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">set_priors</span>(<span class="at">distribution =</span> <span class="st">"jeffreys"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Users can also provide custom priors. The simplest way to specify custom priors is to add them as a vector of numbers using <code>set_priors()</code>. For instance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">set_priors</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">param_names =</span> <span class="fu">c</span>(<span class="st">"X.10"</span>, <span class="st">"X.01"</span>), <span class="at">alphas =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspect</span>(<span class="st">"prior_hyperparameters"</span>, <span class="at">nodes =</span> <span class="st">"X"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
prior_hyperparameters
Alpha parameter values used for Dirichlet prior distributions:

X.00 X.10 X.01 X.11 
   1    3    4    1 </code></pre>
</div>
</div>
<p>The priors here should be interpreted as indicating <span class="math inline">\(\alpha_X = (1, 3, 4, 1)\)</span>, which implies a distribution over <span class="math inline">\((\lambda^X_{00},\lambda^X_{10}, \lambda^X_{01}, \lambda^X_{11})\)</span> with expectation <span class="math inline">\(\left(\frac{1}{9}, \frac{3}{9}, \frac{4}{9}, \frac{1}{9} \right)\)</span>.</p>
<p>Providing priors as a vector of numbers for larger models can be hard. For that reason, <code>set_priors()</code> allows for more targeted modifications of the parameter vector. For instance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">set_priors</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">statement =</span> <span class="st">"X[Z = 1] &gt; X[Z = 0]"</span>, <span class="at">alphas =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspect</span>(<span class="st">"prior_hyperparameters"</span>, <span class="at">nodes =</span> <span class="st">"X"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
prior_hyperparameters
Alpha parameter values used for Dirichlet prior distributions:

X.00 X.10 X.01 X.11 
   1    1    3    1 </code></pre>
</div>
</div>
<!-- Setting priors requires mapping alpha values to parameters, and so the problem of altering priors reduces to selecting rows of the `parameters_df` data frame at which to alter values. When specifying a causal statement as above, [CausalQueries]{.pkg} internally identifies nodal types consistent with the statement, which identifies parameters to alter priors for. -->
<p>While setting highly targeted priors is convenient and flexible, it should be done with caution. Assigning priors to specific parameters in complex models, particularly those involving confounding, can significantly impact inferences (see <span class="citation" data-cites="richardson2011transparent">Richardson, Evans, and Robins (<a href="#ref-richardson2011transparent" role="doc-biblioref">2011</a>)</span> on an approach to specifying priors that more clearly separates beliefs over identifies and non-identified components). Additionally, note that flat priors over nodal types do not necessarily equate to flat priors over queries. Flat priors over parameters within a parameter family assign equal weight to each nodal type, which can lead to strong assumptions about causal quantities of interest. For example, in an <span class="math inline">\(X \rightarrow Y\)</span> model where negative effects are excluded, the average causal effect implied by flat priors is <span class="math inline">\(1/3\)</span>. This can be demonstrated by querying the model as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_restrictions</span>(<span class="fu">decreasing</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query_model</span>(<span class="st">"Y[X = 1] - Y[X = 0]"</span>, <span class="at">using =</span> <span class="st">"priors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>More subtly, the <em>structure</em> of a model, coupled with flat priors, has substantive importance for priors on causal quantities. For instance, with flat priors, prior on the probability that <span class="math inline">\(X\)</span> has a positive effect on <span class="math inline">\(Y\)</span> in the model <span class="math inline">\(X \rightarrow Y\)</span> is centered on <span class="math inline">\(1/4\)</span>. But prior on the probability that <span class="math inline">\(X\)</span> positively affects <span class="math inline">\(Y\)</span> in the model <span class="math inline">\(X \rightarrow M \rightarrow Y\)</span> is centered on <span class="math inline">\(1/8\)</span>. Caution regarding priors is essential when queries are not identified, as is the case for many models considered here. For some quantities, the marginal posterior distribution reflects the marginal prior distribution <span class="citation" data-cites="poirier_revising_1998">(<a href="#ref-poirier_revising_1998" role="doc-biblioref">Poirier 1998</a>)</span>.</p>
</section>
<section id="parameters" class="level4">
<h4 class="anchored" data-anchor-id="parameters">Setting parameters</h4>
<p>By default, models include a vector of parameter values within the <code>parameters_df</code> data frame. These values are useful for generating data or for scenarios like process tracing, where inferences about causal types (<span class="math inline">\(\theta\)</span>) are made from case-level data, assuming the model is known. The process of setting parameters is similar to setting priors. The key difference is that while the <span class="math inline">\(\alpha\)</span> value assigned to nodal types can be any positive number—reflecting our confidence in the parameter value—the parameter values themselves must be within the unit interval, <span class="math inline">\([0,1]\)</span>. If parameter values provided are outside this interval, they are normalized to fit within it.</p>
<p>The causal model below has two parameter sets, one for <span class="math inline">\(X\)</span> and one for <span class="math inline">\(Y\)</span>, with two nodal types for <span class="math inline">\(X\)</span> and four for <span class="math inline">\(Y\)</span>. The key feature of the parameters is that they must sum to <span class="math inline">\(1\)</span> within each parameter set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">inspect</span>(<span class="st">"parameters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
parameters
Model parameters with associated probabilities: 

 X.0  X.1 Y.00 Y.10 Y.01 Y.11 
0.50 0.50 0.25 0.25 0.25 0.25 </code></pre>
</div>
</div>
<p>The example below illustrates a change in the value of the parameter that corresponds to a positive effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>. Here, the nodal type <code>Y.Y01</code> is set to be <span class="math inline">\(0.7\)</span>, while the other nodal types of this parameter set were re-normalized so that the parameters in the set still sum up to one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">set_parameters</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">statement =</span> <span class="st">"Y[X = 1] &gt; Y[X = 0]"</span>, <span class="at">parameters =</span> .<span class="dv">7</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspect</span>(<span class="st">"parameters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
parameters
Model parameters with associated probabilities: 

 X.0  X.1 Y.00 Y.10 Y.01 Y.11 
 0.5  0.5  0.1  0.1  0.7  0.1 </code></pre>
</div>
</div>
</section>
</section>
<section id="drawing-and-manipulating-data" class="level3">
<h3 class="anchored" data-anchor-id="drawing-and-manipulating-data">Drawing and manipulating data</h3>
<p>Once a model has been defined, it is possible to simulate data from the model using the <code>make_data()</code> function. For instance, this can be useful for assessing a model’s expected performance given data drawn from some speculated set of parameter values.</p>
<section id="drawing-data-basics" class="level4">
<h4 class="anchored" data-anchor-id="drawing-data-basics">Drawing data basics</h4>
<p>Generating data requires a specification of parameter values. The parameter values in the parameters data frame are used by default. Otherwise users can provide parameters on the fly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">make_data</span>(<span class="at">n =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Z X Y
1 0 1 1
2 1 0 0
3 1 1 1
4 1 1 1</code></pre>
</div>
</div>
<p>The resulting data is ordered by data type, as shown in the example above. Users can also specify parameters directly or draw parameters from a prior or posterior distribution by specifying <code>param_type</code> argument in the <code>make_data()</code> call.</p>
</section>
<section id="drawing-incomplete-data" class="level4">
<h4 class="anchored" data-anchor-id="drawing-incomplete-data">Drawing incomplete data</h4>
<p><span class="pkg">CausalQueries</span> can be used when researchers have gathered different amounts of data for different nodes. For example, a researcher might gather data on <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> for all units, but only have data on <span class="math inline">\(M\)</span> for some units. The <code>make_data()</code> function enables users to simulate such data by specifying a data strategy that outlines the probabilities of observing data for different nodes, potentially based on previously observed nodes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">make_data</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">8</span>, <span class="at">nodes =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"Z"</span>, <span class="st">"Y"</span>), <span class="st">"X"</span>), <span class="at">probs =</span> <span class="fu">list</span>(<span class="dv">1</span>, .<span class="dv">5</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">subsets =</span> <span class="fu">list</span>(<span class="cn">TRUE</span>, <span class="st">"Z == 1 &amp; Y == 0"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reshaping-data" class="level4">
<h4 class="anchored" data-anchor-id="reshaping-data">Reshaping data</h4>
<p>Data produced by <code>make_data()</code> typically comes in a “long” format, where each row represents a single observation. However, it can be useful to have data a “compact” format that summarizes the number of units for each data type, organized by data “strategy,” indicating the nodes for which data was collected. The <span class="pkg">CausalQueries</span> package provides function <code>collapse_data()</code> that allow users to convert data to compact format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sample_data <span class="sc">|&gt;</span> <span class="fu">collapse_data</span>(lipids_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    event strategy count
1  Z0X0Y0      ZXY     0
2  Z1X0Y0      ZXY     0
3  Z0X1Y0      ZXY     0
4  Z1X1Y0      ZXY     0
5  Z0X0Y1      ZXY     1
6  Z1X0Y1      ZXY     0
7  Z0X1Y1      ZXY     0
8  Z1X1Y1      ZXY     0
9    Z0Y0       ZY     2
10   Z1Y0       ZY     1
11   Z0Y1       ZY     2
12   Z1Y1       ZY     2</code></pre>
</div>
</div>
<p>In the same way, it is possible to move from compact to long format using <code>expand_data()</code>.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
</section>
</section>
</section>
<section id="sec-update" class="level2">
<h2 class="anchored" data-anchor-id="sec-update">Updating models</h2>
<p>The approach used by the <span class="pkg">CausalQueries</span> package to update parameter values given observed data relies on the Stan programming language <span class="citation" data-cites="carpenter_stan_2017">(<a href="#ref-carpenter_stan_2017" role="doc-biblioref">Carpenter et al. 2017</a>)</span>. Below we explain the data required by the generic Stan program implemented in the package, the structure of that program, and then show how to use the package to produce posterior draws of parameters.</p>
<section id="data-for-stan" class="level3">
<h3 class="anchored" data-anchor-id="data-for-stan">Data for Stan</h3>
<p>We use a generic Stan program that works for all binary causal models. The main advantage of the generic program is that it allows us to pass the details of the causal model as data inputs to Stan instead of generating individual Stan programs for each causal model. <a href="#sec-stancode">Appendix B</a> provides the complete Stan model code.</p>
<p>The data required by the Stan program includes vectors of observed data and priors on parameters, as well as a set of matrices needed for the mapping between events, data types, causal types, and parameters. In addition, data passed to <code>stan</code> includes counts of all relevant quantities as well as start and end positions of parameters pertaining to specific nodes and distinct data strategies. The internal function <code>prep_stan_data()</code> takes the model and data as arguments and produces a list with all objects that are required by the generic Stan program. Package users do not need to call the <code>prep_stan_data()</code> function directly.</p>
</section>
<section id="how-the-stan-program-works" class="level3">
<h3 class="anchored" data-anchor-id="how-the-stan-program-works">How the Stan program works</h3>
<p>The Stan model involves the following elements: (1) a specification of priors over sets of parameters, (2) a mapping from parameters to event probabilities, and (3) a likelihood function. Below, we describe each of those elements in more detail.</p>
<section id="probability-distributions-over-parameter-sets" class="level4">
<h4 class="anchored" data-anchor-id="probability-distributions-over-parameter-sets">Probability distributions over parameter sets</h4>
<p>The causal structure provided by a DAG simplifies the problem of generating a probability distribution over all parameters by focusing on distributions over sets of parameters. In the absence of unobserved confounding, these sets correspond to the nodal types for each node, resulting in a probability distribution over these nodal types. For example, in the <span class="math inline">\(X \rightarrow Y\)</span> model, there are two parameter sets. The <span class="math inline">\(X\)</span> nodal types are represented by a 2-dimensional Dirichlet distribution, <span class="math inline">\((\lambda^X_0, \lambda^X_1) \sim \text{Dirichlet}(\alpha^X_0, \alpha^X_1)\)</span>, and the <span class="math inline">\(Y\)</span> nodal types are represented by a <span class="math inline">\(4\)</span>-dimensional Dirichlet distribution, <span class="math inline">\((\lambda^Y_{00}, \lambda^Y_{10}, \lambda^Y_{01}, \lambda^Y_{11}) \sim \text{Dirichlet}(\alpha^Y_{00}, \alpha^Y_{10}, \alpha^Y_{01}, \alpha^Y_{11})\)</span>.</p>
<p>In cases involving confounding, these parameter sets are defined for a given node, conditional on the values of other nodes.</p>
</section>
<section id="event-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="event-probabilities">Event probabilities</h4>
<p>We calculate the probability of data types for any parameter vector <span class="math inline">\(\lambda\)</span>. This is done using a matrix that maps from parameters into data types.</p>
<p>In cases without confounding, there is a column for each data type; the matrix indicates which nodes in each set “contribute” to the data type, and the probability of the data type is found by summing within sets and taking the product over sets. To illustrate, we can examine the parameter mapping matrix for a simple model using the <code>inspect()</code> function as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">inspect</span>(<span class="st">"parameter_mapping"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
parameter_mapping (Parameter mapping matrix) 

  Maps from parameters to data types, with
  possibly multiple columns for each data type
  in cases with confounding. 

     X0Y0 X1Y0 X0Y1 X1Y1
X.0     1    0    1    0
X.1     0    1    0    1
Y.00    1    1    0    0
Y.10    0    1    1    0
Y.01    1    0    0    1
Y.11    0    0    1    1</code></pre>
</div>
</div>
<p>The probability of each data type can be determined using the parameter mapping matrix by combining a parameter vector with the corresponding column of the matrix. For instance, in the model above, the probability of the data type <code>X0Y0</code>, denoted as <span class="math inline">\(w_{00}\)</span>, is calculated as <span class="math inline">\(\lambda^X_0 \times (\lambda^Y_{00} + \lambda^Y_{01})\)</span>. This represents the product of the probability of <code>X.0</code> and the sum of the probabilities for <code>Y.00</code> and <code>Y.01</code>.</p>
<p>In cases with confounding, the approach is similar, except that the parameter mapping matrix can contain multiple columns for each data type to capture non-independence between nodes.</p>
<p>In the case of incomplete data, we first identify the set of data strategies, where a collection of a data strategy might be of the form “gather data on <span class="math inline">\(X\)</span> and <span class="math inline">\(M\)</span>, but not <span class="math inline">\(Y\)</span>, for <span class="math inline">\(n_1\)</span> cases and gather data on <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, but not <span class="math inline">\(M\)</span>, for <span class="math inline">\(n_2\)</span> cases.” Within a data strategy, the probability of an observed event is given by summing the probabilities of the types that could give rise to a particular pattern of incomplete data.</p>
</section>
<section id="data-probability" class="level4">
<h4 class="anchored" data-anchor-id="data-probability">Data probability</h4>
<p>Once we have the event probabilities in hand for each data strategy, we are ready to calculate the probability of the data. For a given data strategy, this is given by a multinomial distribution with these event probabilities. When there is incomplete data, and so there are multiple data strategies, the probability of the data is given by the product of the multinomial probabilities for data generated by each strategy.</p>
</section>
</section>
<section id="implementation" class="level3">
<h3 class="anchored" data-anchor-id="implementation">Implementation</h3>
<p>The <code>update_model()</code> function is used to update a model by appending a posterior distribution over the model parameters. This function utilizes <code>rstan::sampling()</code> to draw from the posterior distribution, and users can pass any additional arguments that <code>rstan::sampling()</code> accepts. Since model updating can be slow for complex models, <a href="#sec-parallel">Appendix A</a> demonstrates how users can employ parallelization to enhance computation speed. <a href="#sec-benchmark">Appendix C</a> offers an overview of model updating benchmarks, assessing the impact of model complexity and data size on updating times.</p>
<p>Users have the option to provide a <code>data</code> argument when calling <code>update_model()</code>. This argument should be a data frame that includes some or all of the nodes in the model. It is optional; if no data is provided, the Stan model will still run, and the resulting posterior distribution added to the model will be interpreted as draws from the prior distribution.</p>
</section>
<section id="incomplete-and-censored-data" class="level3">
<h3 class="anchored" data-anchor-id="incomplete-and-censored-data">Incomplete and censored data</h3>
<p><span class="pkg">CausalQueries</span> assumes that missing data is missing at random, conditional on observed data. For instance, in an <span class="math inline">\(X \rightarrow M \rightarrow Y\)</span> model, a researcher might have chosen to collect data on <span class="math inline">\(M\)</span> in a random set of cases in which <span class="math inline">\(X=1\)</span> and <span class="math inline">\(Y=1\)</span>. If there are positive relations at each stage, one may be more likely to observe <span class="math inline">\(M\)</span> in cases in which <span class="math inline">\(M=1\)</span>. However, the observation of <span class="math inline">\(M\)</span> is still random and conditional on the observed <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> data. The Stan model in <span class="pkg">CausalQueries</span> takes account of this kind of sampling by assessing the probability of observing a particular pattern of data within each data strategy.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p>Additionally, you can specify when data has been censored, allowing the Stan model to account for it. For example, consider a scenario where we only observe <span class="math inline">\(X\)</span> when <span class="math inline">\(X=1\)</span> and not when <span class="math inline">\(X=0\)</span>. This type of sampling is non-random and depends on observable variables. You can address this by informing Stan that the probability of observing a particular data type is <span class="math inline">\(0\)</span>, regardless of parameter values. This is achieved using the <code>censored_types</code> argument in <code>update_model()</code>.</p>
<p>To illustrate, in the example below, we observe perfectly correlated data for <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>. If we are aware that data in which <span class="math inline">\(X \neq Y\)</span> has been censored, then when we update, we do not move towards a belief that <span class="math inline">\(X\)</span> causes <span class="math inline">\(Y\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">5</span>), <span class="at">Y =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">5</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">uncensored =</span> <span class="fu">update_model</span>(<span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>), </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data, <span class="at">refresh =</span> <span class="dv">0</span>),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">update_model</span>(<span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>), <span class="at">data =</span> data, </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored_types =</span> <span class="fu">c</span>(<span class="st">"X1Y0"</span>,  <span class="st">"X0Y1"</span>), <span class="at">refresh =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query_model</span>(<span class="st">"Y[X = 1] - Y[X = 0]"</span>, <span class="at">using =</span> <span class="st">"posteriors"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>using)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Causal queries generated by query_model

|model      |case_level |  mean|    sd| cred.low| cred.high|
|:----------|:----------|-----:|-----:|--------:|---------:|
|uncensored |FALSE      | 0.590| 0.196|    0.145|     0.897|
|censored   |FALSE      | 0.015| 0.318|   -0.625|     0.641|</code></pre>
</div>
</div>
</section>
<section id="output" class="level3">
<h3 class="anchored" data-anchor-id="output">Output</h3>
<p>The main output of the <code>update_model()</code> function is a model that includes a posterior distribution of the model parameters, stored as a data frame within the model list. You can access this posterior distribution directly using the <code>grab()</code> function (or use the <code>inspect()</code> function for a more detailed output) as shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>()</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">inspect</span>(model, <span class="st">"posterior_distribution"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
posterior_distribution
Summary statistics of model parameters posterior distributions:

  Distributions matrix dimensions are 
  4000 rows (draws) by 6 cols (parameters)

     mean   sd
X.0  0.49 0.29
X.1  0.51 0.29
Y.00 0.25 0.20
Y.10 0.26 0.20
Y.01 0.25 0.19
Y.11 0.24 0.19</code></pre>
</div>
</div>
<p>Additionally, a distribution of causal types is stored by default. Optionally, the <code>stanfit</code> object and a distribution over event probabilities can also be saved as shown below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="ot">&lt;-</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">update_model</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">keep_fit =</span> <span class="cn">TRUE</span>, <span class="at">keep_event_probabilities =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The summary of the Stan model can be accessed using <code>inspect()</code> function and is saved in the updated model object by default.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>(<span class="at">keep_type_distribution =</span> <span class="cn">FALSE</span>, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">inspect</span>(<span class="st">"stan_summary"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
stan_summary
Stan model summary:

Inference for Stan model: simplexes.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                   mean se_mean   sd   2.5%   25%   50%   75% 97.5% n_eff Rhat
X.0                0.49    0.01 0.29   0.02  0.24  0.49  0.75  0.97  2976 1.00
X.1                0.51    0.01 0.29   0.03  0.25  0.51  0.76  0.98  2976 1.00
Y.00               0.25    0.01 0.19   0.01  0.09  0.20  0.37  0.71  1419 1.00
Y.10               0.25    0.00 0.19   0.01  0.09  0.20  0.37  0.71  4026 1.00
Y.01               0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.71  4142 1.00
Y.11               0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.71  4265 1.00
lp__               1.02    0.02 1.00   0.03  0.29  0.71  1.43  3.75  2419 1.00
log_sum_gammas[2]  1.86    0.05 1.27   0.34  0.99  1.59  2.42  4.99   649 1.01
lp__              -7.58    0.05 1.72 -11.74 -8.44 -7.17 -6.34 -5.43  1185 1.00

Samples were drawn using NUTS(diag_e) at Mon Aug 25 17:33:30 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>This summary provides information on the distribution of parameters and convergence diagnostics, summarized in the <code>Rhat</code> column. The last row shows the unnormalized log density on Stan’s unconstrained space, which is intended to diagnose sampling efficiency and evaluate approximations.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> This summary can also include summaries for the transformed parameters if users retain these.</p>
</section>
<section id="convergence-problems-and-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="convergence-problems-and-diagnostics">Convergence problems and diagnostics</h3>
<p>There is no guarantee that updating will produce reliable posterior draws. Indeed for some models, convergence failure are predictable. Fortunately, <code>stan</code> provides warnings that alert users to possible problems. These warnings are retained by <span class="pkg">CausalQueries</span> and repeated in model summaries or when queries are posed.</p>
<p>In the example below the missing data on <span class="math inline">\(M\)</span> means that there is no information to assess whether the strong relation between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is due to positive effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; M -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">10000</span>), <span class="at">Y =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">10000</span>)), </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">5000</span>, <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The print and summary methods returns warnings alerting users to the problem thus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Causal statement: 
M -&gt; Y; X -&gt; M

Number of nodal types by node:
X M Y 
2 4 4 

Number of causal types: 32

Model has been updated and contains a posterior distribution with
4 chains, each with iter=5000; warmup=2500; thin=1;  
Use inspect(model, 'stan_summary') to inspect stan summary

Warnings passed from rstan during updating:
The largest R-hat is 1.53, indicating chains have not mixed
Bulk Effective Samples Size (ESS) is too low
Tail Effective Samples Size (ESS) is too low </code></pre>
</div>
</div>
<p>If users wish to run more advanced diagnostics of performance, they can retain and access the “raw” Stan output as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(<span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">keep_fit =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the raw output uses labels from the generic Stan model: <code>lambda</code> for the vector of parameters, corresponding to the parameters in the parameters data frame (<code>inspect(model, "parameters_df")</code>), a vector <code>types</code> for the causal types (<code>inspect(model, "causal_types")</code>) and <code>event_probabilities</code> for the event probabilities (<code>inspect(model, "event_probabilities")</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">inspect</span>(<span class="st">"stanfit"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
stanfit
Stan model summary:
Inference for Stan model: simplexes.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

                   mean se_mean   sd   2.5%   25%   50%   75% 97.5% n_eff Rhat
lambdas[1]         0.50    0.01 0.29   0.03  0.25  0.49  0.74  0.97  3036 1.00
lambdas[2]         0.50    0.01 0.29   0.03  0.26  0.51  0.75  0.97  3036 1.00
lambdas[3]         0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.70  2031 1.00
lambdas[4]         0.25    0.00 0.19   0.01  0.09  0.21  0.37  0.71  4633 1.00
lambdas[5]         0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.72  4162 1.00
lambdas[6]         0.25    0.00 0.20   0.01  0.09  0.20  0.37  0.71  4701 1.00
log_sum_gammas[1]  1.00    0.02 0.96   0.03  0.30  0.72  1.39  3.43  2536 1.00
log_sum_gammas[2]  1.85    0.03 1.19   0.36  1.00  1.58  2.41  4.93  1159 1.01
types[1]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.50  2065 1.00
types[2]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.48  2390 1.00
types[3]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.50  3785 1.00
types[4]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.49  3407 1.00
types[5]           0.12    0.00 0.13   0.00  0.03  0.08  0.18  0.48  3507 1.00
types[6]           0.13    0.00 0.13   0.00  0.03  0.08  0.18  0.49  3619 1.00
types[7]           0.12    0.00 0.13   0.00  0.03  0.08  0.17  0.49  3841 1.00
types[8]           0.13    0.00 0.13   0.00  0.03  0.08  0.19  0.49  3863 1.00
lp__              -7.53    0.04 1.65 -11.75 -8.37 -7.15 -6.32 -5.44  1368 1.00

Samples were drawn using NUTS(diag_e) at Mon Aug 25 17:33:43 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Users can then pass the <code>stanfit</code> object to other diagnostic packages such as <span class="pkg">bayesplot</span>.</p>
</section>
</section>
<section id="sec-query" class="level2">
<h2 class="anchored" data-anchor-id="sec-query">Queries</h2>
<p><span class="pkg">CausalQueries</span> provides functionality to pose and answer elaborate causal queries. The key approach is to code causal queries as functions of causal types and return a distribution over the queries implied by the distribution over causal types. The primary approach is to use <code>query_model()</code> to generate an object of class <code>model_query</code> (see <a href="#sec-classes" class="quarto-xref">Section&nbsp;5</a>) which prints to a table or can be plotted directly. The next sections describe how such queries are calculated and the syntax used for posing queries.</p>
<section id="sec-propagation" class="level3">
<h3 class="anchored" data-anchor-id="sec-propagation">Calculating factual and counterfactual quantities</h3>
<p>An essential step in calculating most queries is assessing what outcomes will arise for causal types given different interventions on nodes. In practice, we map from causal types to data types by propagating realized values on nodes forward in the DAG, moving from exogenous or intervened upon nodes to their descendants in generational order. An internal function, <code>realise_outcomes()</code>, achieves this by traversing the DAG while recording the values implied by realizations on the node’s parents for each node’s nodal types.</p>
<p>To illustrate, consider the first causal type of a <span class="math inline">\(X \rightarrow Y\)</span> model:</p>
<ol type="1">
<li><span class="math inline">\(\theta^X_0\)</span> implies that, absent intervention on <span class="math inline">\(X\)</span>, <span class="math inline">\(X\)</span> has a realized value of <span class="math inline">\(0\)</span>; <span class="math inline">\(\theta^Y_{00}\)</span> implies that, absent intervention on <span class="math inline">\(Y\)</span>, <span class="math inline">\(Y\)</span> has a realized value of <span class="math inline">\(0\)</span> regardless of <span class="math inline">\(X\)</span>.</li>
<li>We substitute for <span class="math inline">\(Y\)</span> the value implied by the <span class="math inline">\(00\)</span> nodal type given a <span class="math inline">\(0\)</span> value on <span class="math inline">\(X\)</span>, which in turn is <span class="math inline">\(0\)</span>.</li>
</ol>
<p>The <code>realise_outcomes()</code> function, when called on this model, outputs the realized values for all causal types, with row names indicating the corresponding causal types.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">realise_outcomes</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     X Y
0.00 0 0
1.00 1 0
0.10 0 1
1.10 1 0
0.01 0 0
1.01 1 1
0.11 0 1
1.11 1 1</code></pre>
</div>
</div>
<p>Intervening on <span class="math inline">\(X\)</span> <span class="citation" data-cites="pearl_causality_2009">(see <a href="#ref-pearl_causality_2009" role="doc-biblioref">Pearl 2009</a>)</span> with <span class="math inline">\(\text{do}(X=1)\)</span> yields:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">realise_outcomes</span>(<span class="at">dos =</span> <span class="fu">list</span>(<span class="at">X =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     X Y
0.00 1 0
1.00 1 0
0.10 1 0
1.10 1 0
0.01 1 1
1.01 1 1
0.11 1 1
1.11 1 1</code></pre>
</div>
</div>
<p>Similarly, <code>realise_outcomes()</code> can return the realized values on all nodes for each causal type given arbitrary interventions.</p>
</section>
<section id="sec-syntax" class="level3">
<h3 class="anchored" data-anchor-id="sec-syntax">Causal syntax</h3>
<p><span class="pkg">CausalQueries</span> provides syntax for the formulation of various causal queries including queries on all rungs of the “causal ladder” <span class="citation" data-cites="pearl_causality_2009">(<a href="#ref-pearl_causality_2009" role="doc-biblioref">Pearl 2009</a>)</span>: prediction, such as the proportion of units where <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span>; intervention, such as the probability that <span class="math inline">\(Y = 1\)</span> when <span class="math inline">\(X\)</span> is <em>set</em> to <span class="math inline">\(1\)</span>; counterfactuals, such as the probability that <span class="math inline">\(Y\)</span> would be <span class="math inline">\(1\)</span> were <span class="math inline">\(X = 1\)</span> given we know <span class="math inline">\(Y\)</span> is <span class="math inline">\(0\)</span> when <span class="math inline">\(X\)</span> was observed to be <span class="math inline">\(0\)</span>. Queries can be posed at the population level or case level and can be unconditional (e.g., what is the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> for all units) or conditional (for example, the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> for units for which <span class="math inline">\(Z\)</span> affects <span class="math inline">\(X\)</span>). This syntax enables users to write arbitrary causal queries to interrogate their models.</p>
<p>The core of querying involves determining which causal types correspond to specific queries. Users can use logical statements to inquire about observed conditions without interventions for factual queries. For instance, consider the query about the proportion of units where <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span>, expressed as <code>"Y == 1"</code>. Here, the logical operator <code>==</code> signifies that <span class="pkg">CausalQueries</span> should consider units that meet the strict equality condition where <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span>.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> When this query is executed, the <code>get_query_types()</code> function identifies all types that result in <span class="math inline">\(Y=1\)</span> without any interventions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>)  <span class="sc">|&gt;</span> <span class="fu">get_query_types</span>(<span class="st">"Y == 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Causal types satisfying query's condition(s)  

 query =  Y==1 

X0.Y10  X1.Y01
X0.Y11  X1.Y11


 Number of causal types that meet condition(s) =  4
 Total number of causal types in model =  8</code></pre>
</div>
</div>
<p>The key to forming causal queries is being able to ask about the values of variables, given that the values of some other variables are “controlled.” This corresponds to the application of the <span class="math inline">\(do\)</span> operator in <span class="citation" data-cites="pearl_causality_2009">Pearl (<a href="#ref-pearl_causality_2009" role="doc-biblioref">2009</a>)</span>. In <span class="pkg">CausalQueries</span>, this is done by putting square brackets, <code>[ ]</code>, around variables that are intervened upon.</p>
<p>For instance, consider the query <code>Y[X = 0] == 1</code>. This query asks about the types for which <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span> when <span class="math inline">\(X\)</span> is set to <span class="math inline">\(0\)</span>. Since <span class="math inline">\(X\)</span> is set to zero, <span class="math inline">\(X\)</span> is placed inside the brackets. Given that <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span> is a condition about potentially observed values, it is expressed using the logical operator <code>==</code>. The set of causal types that meets this query is quite different:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">get_query_types</span>(<span class="st">"Y[X = 0] == 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Causal types satisfying query's condition(s)  

 query =  Y[X=0]==1 

X0.Y10  X1.Y10
X0.Y11  X1.Y11


 Number of causal types that meet condition(s) =  4
 Total number of causal types in model =  8</code></pre>
</div>
</div>
<p>When a node has multiple parents, it is possible to set the values of none, some, or all of the parents. For instance if <span class="math inline">\(X1\)</span> and <span class="math inline">\(X2\)</span> are parents of <span class="math inline">\(Y\)</span> then <code>Y == 1</code>, <code>Y[X1 = 1] == 1</code>, and <code>Y[X1 = 1, X2 = 1] == 1</code> queries cases for which <span class="math inline">\(Y=1\)</span> when, respectively, neither parents values are controlled, when <span class="math inline">\(X1\)</span> is set to <span class="math inline">\(1\)</span> but <span class="math inline">\(X2\)</span> is not controlled, and when both <span class="math inline">\(X1\)</span> and <span class="math inline">\(X2\)</span> are set to <span class="math inline">\(1\)</span>. For instance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X1 -&gt; Y &lt;- X2"</span>)  <span class="sc">|&gt;</span> <span class="fu">get_query_types</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"X1 == 1 &amp; X2 == 1 &amp; (Y[X1 = 1, X2 = 1] &gt; Y[X1 = 0, X2 = 0])"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Causal types satisfying query's condition(s)  

 query =  X1==1&amp;X2==1&amp;(Y[X1=1,X2=1]&gt;Y[X1=0,X2=0]) 

X11.X21.Y0001  X11.X21.Y0101
X11.X21.Y0011  X11.X21.Y0111


 Number of causal types that meet condition(s) =  4
 Total number of causal types in model =  64</code></pre>
</div>
</div>
<p>In this case, the aim is to identify the types for which in fact <span class="math inline">\(X1=1\)</span> and <span class="math inline">\(X2=1\)</span> and, <em>in addition</em>, <span class="math inline">\(Y=0\)</span> when <span class="math inline">\(X1 = X2 = 0\)</span> and <span class="math inline">\(Y = 1\)</span> when <span class="math inline">\(X1 = X2 = 1\)</span>.</p>
<section id="conditional-queries" class="level4">
<h4 class="anchored" data-anchor-id="conditional-queries">Conditional queries</h4>
<p>Many queries of interest are “conditional” queries. For example, the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> for units for which <span class="math inline">\(W=1\)</span> or the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> for units for which <span class="math inline">\(Z\)</span> positively affects <span class="math inline">\(X\)</span>. Such conditional queries are posed in <span class="pkg">CausalQueries</span> by providing a <code>given</code> statement and the <code>query</code> statement or by placing the condition following a <code>:|:</code> separator in the query expression. For instance <code>"Y[X = 1] == 1 :|: X == 0"</code> asks for the probability that <span class="math inline">\(Y=1\)</span> when <span class="math inline">\(X\)</span> is set to 1 for a case in which in fact <span class="math inline">\(X=0\)</span>. The entire query then becomes: for what units does the <code>query</code> condition hold among those units for which the <code>given</code> condition holds? The two parts can each be calculated using <code>get_query_types</code>. Thus, for instance, in an <span class="math inline">\(X \rightarrow Y\)</span> model, the probability that <span class="math inline">\(X\)</span> causes <span class="math inline">\(Y\)</span> given <span class="math inline">\(X=1 \, \&amp; \, Y=1\)</span> is the probability of causal <code>X1.Y11</code> type divided by the sum of the probabilities of types <code>X1.Y11</code> and <code>X1.Y01</code>. In practice, this is done automatically for users when they call <code>query_model()</code> or <code>query_distribution()</code>.</p>
</section>
<section id="complex-expressions" class="level4">
<h4 class="anchored" data-anchor-id="complex-expressions">Complex expressions</h4>
<p>Many queries involve complex statements across multiple sets of types, which can be constructed using relational operators. For instance, users can query whether <span class="math inline">\(X\)</span> has a positive effect on <span class="math inline">\(Y\)</span> by checking if <span class="math inline">\(Y\)</span> is greater when <span class="math inline">\(X\)</span> is set to <span class="math inline">\(1\)</span> compared to when <span class="math inline">\(X\)</span> is set to <span class="math inline">\(0\)</span>. This is expressed as <code>"Y[X = 1] &gt; Y[X = 0]"</code>. The query “<span class="math inline">\(X\)</span> has some effect on <span class="math inline">\(Y\)</span>” is given by <code>"Y[X = 1] != Y[X = 0]"</code>.</p>
<p>Linear operators can also be used over a set of simple statements. Thus <code>"Y[X = 1] - Y[X = 0]"</code> returns the average treatment effect. In essence, rather than returning a <code>TRUE</code> or <code>FALSE</code> for the two parts of the query, the case memberships are forced to numeric values (<span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>), and the differences are taken, which can be a <span class="math inline">\(1\)</span>, <span class="math inline">\(0\)</span> or <span class="math inline">\(-1\)</span> depending on the causal type. Averaging provides the share of cases with positive effects, less the share of cases with negative effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">get_query_types</span>(<span class="st">"Y[X = 1] - Y[X = 0]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X0.Y00 X1.Y00 X0.Y10 X1.Y10 X0.Y01 X1.Y01 X0.Y11 X1.Y11 
     0      0     -1     -1      1      1      0      0 </code></pre>
</div>
</div>
</section>
<section id="nested-queries" class="level4">
<h4 class="anchored" data-anchor-id="nested-queries">Nested queries</h4>
<p><span class="pkg">CausalQueries</span> lets users pose nested “complex counterfactual” queries. Rather than stipulating a value to which some node is to be set, the user can set the value to the value that the node would take given actions taken on ancestor nodes. For instance <code>"Y[M = M[X = 0], X = 1] == 1"</code> queries the types for which <span class="math inline">\(Y\)</span> equals <span class="math inline">\(1\)</span> when <span class="math inline">\(X\)</span> is set to <span class="math inline">\(1\)</span>, while keeping <span class="math inline">\(M\)</span> constant at whatever value it would take if <span class="math inline">\(X\)</span> were set to <span class="math inline">\(0\)</span>. Such values are important for defining queries such as the “natural direct effect” <span class="citation" data-cites="pearl2022direct">(<a href="#ref-pearl2022direct" role="doc-biblioref">Pearl 2022</a>)</span>.</p>
</section>
</section>
<section id="quantifying-queries" class="level3">
<h3 class="anchored" data-anchor-id="quantifying-queries">Quantifying queries</h3>
<p>To provide a <em>quantitative</em> answer to a query, it is necessary to assign probabilities to the causal types that correspond to the query.</p>
<section id="queries-by-hand" class="level4">
<h4 class="anchored" data-anchor-id="queries-by-hand">Queries by hand</h4>
<p>Queries can be calculated directly from the prior distribution or the posterior distribution provided by Stan. For instance, the following call plots the posterior distribution for the probability that <span class="math inline">\(Y\)</span> is increasing in <span class="math inline">\(X\)</span> for the <span class="math inline">\(X \rightarrow Y\)</span> model. The resulting plot is shown in <a href="#fig-posterior-dist" class="quarto-xref">Figure&nbsp;2</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>data  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">50</span>), <span class="at">Y =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">50</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span>  <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>(</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  data, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>model <span class="sc">|&gt;</span> <span class="fu">grab</span>(<span class="st">"posterior_distribution"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Y<span class="fl">.01</span> <span class="sc">-</span> Y<span class="fl">.10</span>)) <span class="sc">+</span> <span class="fu">geom_histogram</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-posterior-dist" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="t" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-posterior-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-posterior-dist-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%" data-fig-pos="t">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-posterior-dist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Posterior on “Probability <span class="math inline">\(Y\)</span> is increasing in <span class="math inline">\(X\)</span>”.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="query-distribution" class="level4">
<h4 class="anchored" data-anchor-id="query-distribution">Query distribution</h4>
<p>It is generally helpful to use causal syntax to define the query and calculate the query with respect to the prior or posterior probability distributions. This can be done for a list of queries using <code>query_distribution()</code> function as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>queries <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">query_distribution</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">query =</span> <span class="fu">list</span>(<span class="at">increasing =</span> <span class="st">"(Y[X = 1] &gt; Y[X = 0])"</span>, </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">ATE =</span> <span class="st">"(Y[X = 1] - Y[X = 0])"</span>), <span class="at">using =</span> <span class="st">"priors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is a data frame with one column per query and rows for draws from prior or posterior distributions as requested.</p>
<p>The core function <code>query_model</code> implements <code>query_distribution</code> and reports summaries of distributions.</p>
</section>
<section id="case-queries" class="level4">
<h4 class="anchored" data-anchor-id="case-queries">Case queries</h4>
<p>The commands <code>query_distribution()</code> and <code>query_model()</code> can also be used when one is interested in assessing the value of a query about a new case that we might confront.</p>
<p>In a sense, this is equivalent to posing a conditional query, querying conditional on values in a case. For instance, we might consult our posterior for the Lipids model and ask about the effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span> for a case in which <span class="math inline">\(Z=1\)</span>, <span class="math inline">\(X=1\)</span> and <span class="math inline">\(Y=1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lipids_model <span class="sc">|&gt;</span> <span class="fu">query_model</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">query =</span> <span class="st">"Y[X = 1] - Y[X = 0] :|: X == 1 &amp; Y == 1 &amp; Z == 1"</span>,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">using =</span> <span class="st">"posteriors"</span>) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-case-level-query" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-case-level-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-case-level-query-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-case-level-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Illustration of case-level queries plotted.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The result in <a href="#fig-case-level-query" class="quarto-xref">Figure&nbsp;3</a> is what we should now believe for all cases in which <span class="math inline">\(Z=1\)</span>, <span class="math inline">\(X=1\)</span>, and <span class="math inline">\(Y=1\)</span>. It is the expected average effect among cases with this data type, so this expectation has an uncertainty attached to it, reflecting our uncertainty about the expectation.</p>
<p>This can differ, however, from what we would infer if we were presented with a new case drawn from the population. When examining a new case, we must <em>update</em> based on the information provided about that case. This <em>new</em> case-level inference is calculated when the <code>case_level = TRUE</code> argument is specified. For a query <span class="math inline">\(Q\)</span> and given <span class="math inline">\(D\)</span>, this returns the value <span class="math inline">\(\frac{\int\pi(Q \&amp; D | \lambda_i)p(\lambda_i)d\lambda_i}{\int\pi(D | \lambda_i)p(\lambda_i)d\lambda_i}\)</span>, which may differ from the mean of the distribution <span class="math inline">\(\frac{\pi(Q \&amp; D | \lambda)}{\pi(D | \lambda)}\)</span> given by <span class="math inline">\(\int \frac{\pi(Q \&amp; D | \lambda_i)}{\pi(D | \lambda_i)} p(\lambda_i)d\lambda_i\)</span>.</p>
<p>To illustrate the difference, consider an <span class="math inline">\(X \rightarrow M \rightarrow Y\)</span> model where we are quite certain that <span class="math inline">\(X\)</span> causes <span class="math inline">\(Y\)</span>, but unsure whether this effect works through two positive or two negative effects. If asked what we would think about effects in cases <span class="math inline">\(M=0\)</span> (or with <span class="math inline">\(M=1\)</span>), we have little basis to know whether these are cases in which effects are more or less likely. However, if we randomly find a case and we observe that <span class="math inline">\(M=0\)</span>, our understanding of the causal model evolves, leading us to believe there is (or is not) an effect in this specific case. The case-level query gives a single value without posterior standard deviation, representing the belief about this new case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_model</span>(<span class="st">"X -&gt; M -&gt; Y"</span>) <span class="sc">|&gt;</span> <span class="fu">update_model</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">8</span>), <span class="at">Y =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">8</span>)), <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">refresh =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query_model</span>(<span class="st">"Y[X = 1] &gt; Y[X = 0] :|: X == 1 &amp; Y == 1 &amp; M == 1"</span>, </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">using =</span> <span class="st">"posteriors"</span>, <span class="at">case_level =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-new-case-level-query" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-new-case-level-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-new-case-level-query-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-new-case-level-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Illustration of new case-level queries plotted.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="batch-queries" class="level4">
<h4 class="anchored" data-anchor-id="batch-queries">Batch queries</h4>
<p>The function <code>query_model()</code> can also be used to pose multiple queries of multiple models in batch. The function takes a list of models, causal queries, and conditions as inputs. It then calculates population or case level estimands given prior or posterior distributions and reports summaries of these distributions. The result is a data frame of class <code>model_query</code> (see <a href="#sec-classes" class="quarto-xref">Section&nbsp;5</a>) that can be displayed as a table or used for graphing. The associated <code>plot</code> method produces plots with class <code>c("gg", "ggplot")</code>.</p>
<p>Since users can adjust multiple lists of features of a query there is an option, <code>expand_grid = TRUE</code>, to indicate whether to query with respect to all combinations of supplied arguments.</p>
<p>To illustrate, we return again to the lipids model but now consider two versions, one with and one without a monotonicity restriction imposed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Unrestricted =</span> lipids_model <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update_model</span>(<span class="at">data =</span> lipids_data, <span class="at">refresh =</span> <span class="dv">0</span>),</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Restricted =</span> lipids_model <span class="sc">|&gt;</span> <span class="fu">set_restrictions</span>(<span class="st">"X[Z = 1] &lt; X[Z = 0]"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">update_model</span>(<span class="at">data =</span> lipids_data, <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#tbl-batch-query" class="quarto-xref">Table&nbsp;7</a> then shows the output from a single call to <code>query_model()</code> with the <code>expand_grid</code> argument set to <code>TRUE</code> to generate all combinations of list elements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>queries <span class="ot">&lt;-</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query_model</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    models, </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">query =</span> <span class="fu">list</span>(</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">ATE =</span> <span class="st">"Y[X=1] - Y[X=0]"</span>, </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">POS =</span> <span class="st">"Y[X=1] &gt; Y[X=0] :|: Y==1 &amp; X==1"</span>),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">case_level =</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>), </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">using =</span> <span class="fu">c</span>(<span class="st">"priors"</span>, <span class="st">"posteriors"</span>),</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand_grid =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div id="tbl-batch-query" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-batch-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7: Results for two queries on two models.
</figcaption>
<div aria-describedby="tbl-batch-query-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">label</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">query</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">given</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">using</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">case_level</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.56</td>
</tr>
<tr class="even">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.55</td>
</tr>
<tr class="odd">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.50</td>
</tr>
<tr class="even">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">FALSE</td>
<td style="text-align: center;">0.95</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.56</td>
</tr>
<tr class="even">
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] - Y[X=0]</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.55</td>
</tr>
<tr class="odd">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.50</td>
</tr>
<tr class="even">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">priors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Unrestricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Restricted</td>
<td style="text-align: center;">Y[X=1] &gt; Y[X=0]</td>
<td style="text-align: center;">Y==1 &amp; X==1</td>
<td style="text-align: center;">posteriors</td>
<td style="text-align: center;">TRUE</td>
<td style="text-align: center;">0.95</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<p><a href="#fig-batch" class="quarto-xref">Figure&nbsp;5</a> shows the default plot associated with this query.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-batch" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-batch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="2_paper_files/figure-html/fig-batch-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-batch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Default plotting for a a set of queries over multiple models.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="summary-and-discussion" class="level2">
<h2 class="anchored" data-anchor-id="summary-and-discussion">Summary and discussion</h2>
<p><span class="pkg">CausalQueries</span> provides an intuitive user interface to generate, update, and query causal models defined over binary nodes.</p>
<p>A particular strength is the flexibility users enjoy in specifying the structure of causal models and querying them using an integrated framework. Rather than requiring bespoke functions for different types of problems—studying treatment effects in randomized experiments, complier effects in encouragement designs, or mediation quantities in more complex causal structures—a unified procedure is used for defining models and for updating on model parameters. With updated models in hand, queries involving arbitrary <span class="math inline">\(do\)</span> operations can be posed using an intuitive syntax.</p>
<p>We identify several areas for future expansion of the package’s functionality. One area involves extending the class of models that can be passed to <code>make_model()</code> to accommodate non-binary data and hierarchical data structures. Proofs of concept for both extensions are available in <span class="citation" data-cites="humphreys_integrated_2023">Humphreys and Jacobs (<a href="#ref-humphreys_integrated_2023" role="doc-biblioref">2023</a>)</span>. Inspired by new work in <span class="citation" data-cites="irons2023causally">Irons and Cinelli (<a href="#ref-irons2023causally" role="doc-biblioref">2023</a>)</span>, we see potential in allowing the specification of more flexible prior distributions and developing algorithms for faster updating in these settings. Inspired by conditions for identification of mediation quantities in <span class="citation" data-cites="forastiere2018principal">Forastiere, Mattei, and Ding (<a href="#ref-forastiere2018principal" role="doc-biblioref">2018</a>)</span>, we see potential for allowing more flexible constraints over the joint distribution of nodal types. For querying, we see scope for facilitating nonlinear complex causal queries, such as risk ratios, which currently require combining multiple simple causal queries. Finally, we see potential for more integrated functionality for model validation, including assessments of the sensitivity of conclusions to priors.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="computational-details-and-software-requirements" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="computational-details-and-software-requirements">Computational details and software requirements</h2>
<div data-tbl-colwidths="[30,70]">
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 41%">
<col style="width: 41%">
</colgroup>
<tbody>
<tr class="odd">
<td>Version</td>
<td><ul>
<li>1.4.3</li>
</ul></td>
<td></td>
</tr>
<tr class="even">
<td>Availability</td>
<td><ul>
<li>Stable Release: <a href="https://cran.rstudio.com/web/packages/CausalQueries/index.html" class="uri">https://cran.rstudio.com/web/packages/CausalQueries/index.html</a></li>
<li>Development: <a href="https://github.com/integrated-inferences/CausalQueries" class="uri">https://github.com/integrated-inferences/CausalQueries</a></li>
</ul></td>
<td></td>
</tr>
<tr class="odd">
<td>Issues</td>
<td><ul>
<li><a href="https://github.com/integrated-inferences/CausalQueries/issues" class="uri">https://github.com/integrated-inferences/CausalQueries/issues</a></li>
</ul></td>
<td></td>
</tr>
<tr class="even">
<td>Operating Systems</td>
<td><ul>
<li>Linux</li>
<li>MacOS</li>
<li>Windows</li>
</ul></td>
<td></td>
</tr>
<tr class="odd">
<td>Testing Environments OS</td>
<td><ul>
<li>Ubuntu 22.04.2</li>
<li>Debian 12.2</li>
<li>MacOS</li>
<li>Windows</li>
</ul></td>
<td></td>
</tr>
<tr class="even">
<td>Testing Environments R</td>
<td><ul>
<li>R 4.5.1</li>
<li>R 4.4.3</li>
<li>R 4.4.2</li>
<li>r-devel</li>
</ul></td>
<td></td>
</tr>
<tr class="odd">
<td>R Version</td>
<td><ul>
<li>R(&gt;= 4.2.0)</li>
</ul></td>
<td></td>
</tr>
<tr class="even">
<td>Compiler</td>
<td><ul>
<li>either of the below or similar:</li>
<li>g++</li>
<li>clang++</li>
</ul></td>
<td></td>
</tr>
<tr class="odd">
<td>Stan requirements</td>
<td><ul>
<li>inline</li>
<li>RcppEigen (&gt;= 0.3.3.3.0)</li>
<li>RcppArmadillo (&gt;= 0.12.6.4.0)</li>
<li>RcppParallel (&gt;= 5.1.4)</li>
<li>BH (&gt;= 1.66.0)</li>
<li>StanHeaders (&gt;= 2.26.0)</li>
<li>rstan (&gt;= 2.26.0)</li>
</ul></td>
<td></td>
</tr>
<tr class="even">
<td>R-Packages Depends</td>
<td><ul>
<li>methods</li>
</ul></td>
<td></td>
</tr>
<tr class="odd">
<td>R-Packages Imports</td>
<td><ul>
<li>dirmult (&gt;= 0.1.3-4) |</li>
<li>dplyr |</li>
<li>stats (&gt;= 4.1.1) |</li>
<li>rlang (&gt;= 0.2.0) |</li>
<li>rstan (&gt;= 2.26.0) |</li>
<li>rstantools (&gt;= 2.0.0) |</li>
<li>stringr (&gt;= 1.4.0) |</li>
<li>latex2exp (&gt;= 0.9.4) |</li>
<li>knitr (&gt;= 1.45) |</li>
<li>ggplot2 (&gt;= 3.3.5) |</li>
<li>lifecycle (&gt;= 1.0.1) |</li>
<li>ggraph (&gt;= 2.2.0) |</li>
<li>Rcpp (&gt;= 0.12.0) |</li>
</ul></td>
<td></td>
</tr>
</tbody>
</table>
<p>Computational details and software requirements.</p>
</div>
<p>The results in this paper were obtained using <span class="proglang">R</span>~4.3 with the <span class="pkg">MASS</span>~7.3-60 package. <span class="proglang">R</span> itself and all packages used are available from the Comprehensive <span class="proglang">R</span> Archive Network (CRAN) at <a href="https://CRAN.R-project.org/" class="uri">https://CRAN.R-project.org/</a>.</p>
</section>
<section id="acknowledgments" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We thank Ben Goodrich, who provided generous insights on using <code>stan</code> for this project. We thank Alan M Jacobs for key work in developing the framework underlying the package. Our thanks to Cristian-Liviu Nicolescu, who provided wonderful feedback on the use of the package and a draft of this paper. Our thanks to Jasper Cooper for contributions to the generic function to create Stan code, to <a href="https://clarabicalho.github.io/">Clara Bicalho</a>, who helped figure out the syntax for causal statements, to <a href="https://www.gov.harvard.edu/directory/julio-s-solis-arce/">Julio S. Solís Arce</a> who made many vital contributions figuring out how to simplify the specification of priors, and to <a href="https://merlinheidemanns.github.io/website/">Merlin Heidemanns</a> who figured out the <code>rstantools</code> integration and made myriad code improvements.</p>
</div>
</div>
</div>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-angrist_identification_1996" class="csl-entry" role="listitem">
Angrist, Joshua D., Guido W. Imbens, and Donald B. Rubin. 1996. <span>“Identification of <span>Causal</span> <span>Effects</span> <span>Using</span> <span>Instrumental</span> <span>Variables</span>.”</span> <em>Journal of the American Statistical Association</em> 91 (434): 444–55. <a href="https://doi.org/10.1080/01621459.1996.10476902">https://doi.org/10.1080/01621459.1996.10476902</a>.
</div>
<div id="ref-balke_bounds_1997" class="csl-entry" role="listitem">
Balke, Alexander, and Judea Pearl. 1997. <span>“Bounds on <span>Treatment</span> <span>Effects</span> from <span>Studies</span> with <span>Imperfect</span> <span>Compliance</span>.”</span> <em>Journal of the American Statistical Association</em> 92 (439): 1171–76. <a href="https://doi.org/10.1080/01621459.1997.10474074">https://doi.org/10.1080/01621459.1997.10474074</a>.
</div>
<div id="ref-beaumont_causalnex_2021" class="csl-entry" role="listitem">
Beaumont, Paul, Ben Horsburgh, Philip Pilgerstorfer, Angel Droth, Richard Oentaryo, Steven Ler, Hiep Nguyen, Gabriel Azevedo Ferreira, Zain Patel, and Wesley Leong. 2021. <a href="https://github.com/quantumblacklabs/causalnex">https://github.com/quantumblacklabs/causalnex</a>.
</div>
<div id="ref-carpenter_stan_2017" class="csl-entry" role="listitem">
Carpenter, Bob, Andrew Gelman, Matthew D. Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus A. Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. <span>“: <span>A</span> <span>Probabilistic</span> <span>Programming</span> <span>Language</span>.”</span> <em>Journal of Statistical Software</em> 76: 1. <a href="https://doi.org/10.18637/jss.v076.i01">https://doi.org/10.18637/jss.v076.i01</a>.
</div>
<div id="ref-chickering_clinicians_1996" class="csl-entry" role="listitem">
Chickering, David Maxwell, and Judea Pearl. 1996. <span>“A <span>Clinician</span>’s <span>Tool</span> for <span>Analyzing</span> <span>Non</span>-<span>Compliance</span>.”</span> In <em>Proceedings of the <span>National</span> <span>Conference</span> on <span>Artificial</span> <span>Intelligence</span></em>, 1269–76. <a href="https://cdn.aaai.org/AAAI/1996/AAAI96-188.pdf">https://cdn.aaai.org/AAAI/1996/AAAI96-188.pdf</a>.
</div>
<div id="ref-dawid2017probability" class="csl-entry" role="listitem">
Dawid, A Philip, Monica Musio, and Rossella Murtas. 2017. <span>“The Probability of Causation.”</span> <em>Law, Probability and Risk</em> 16 (4): 163–79.
</div>
<div id="ref-duarte_automated_2023" class="csl-entry" role="listitem">
Duarte, Guilherme, Noam Finkelstein, Dean Knox, Jonathan Mummolo, and Ilya Shpitser. 2023. <span>“An <span>Automated</span> <span>Approach</span> to <span>Causal</span> <span>Inference</span> in <span>Discrete</span> <span>Settings</span>.”</span> <em>Journal of the American Statistical Association</em>, August, 1–16. <a href="https://doi.org/10.1080/01621459.2023.2216909">https://doi.org/10.1080/01621459.2023.2216909</a>.
</div>
<div id="ref-forastiere2018principal" class="csl-entry" role="listitem">
Forastiere, Laura, Alessandra Mattei, and Peng Ding. 2018. <span>“Principal Ignorability in Mediation Analysis: Through and Beyond Sequential Ignorability.”</span> <em>Biometrika</em> 105 (4): 979–86.
</div>
<div id="ref-frangakis_principal_2002" class="csl-entry" role="listitem">
Frangakis, Constantine E., and Donald B. Rubin. 2002. <span>“Principal <span>Stratification</span> in <span>Causal</span> <span>Inference</span>.”</span> <em>Biometrics</em> 58 (1): 21–29. <a href="https://doi.org/10.1111/j.0006-341X.2002.00021.x">https://doi.org/10.1111/j.0006-341X.2002.00021.x</a>.
</div>
<div id="ref-humphreys_integrated_2023" class="csl-entry" role="listitem">
Humphreys, Macartan, and Alan M. Jacobs. 2023. <em>Integrated <span>Inferences</span>: <span>Causal</span> <span>Models</span> for <span>Qualitative</span> and <span>Mixed</span>-<span>Method</span> <span>Research</span></em>. Cambridge University Press. <a href="https://doi.org/10.1017/9781316718636">https://doi.org/10.1017/9781316718636</a>.
</div>
<div id="ref-irons2023causally" class="csl-entry" role="listitem">
Irons, Nicholas J, and Carlos Cinelli. 2023. <span>“Causally Sound Priors for Binary Experiments.”</span> <em>arXiv Preprint arXiv:2308.13713</em>.
</div>
<div id="ref-kalisch_causal_2012" class="csl-entry" role="listitem">
Kalisch, Markus, Martin Mächler, Diego Colombo, Marloes H. Maathuis, and Peter Bühlmann. 2012. <span>“Causal <span>Inference</span> <span>Using</span> <span>Graphical</span> <span>Models</span> with the <span>Package</span> .”</span> <em>Journal of Statistical Software</em> 47 (May): 1–26. <a href="https://doi.org/10.18637/jss.v047.i11">https://doi.org/10.18637/jss.v047.i11</a>.
</div>
<div id="ref-pearl_causality_2009" class="csl-entry" role="listitem">
Pearl, Judea. 2009. <em>Causality</em>. Cambridge University Press.
</div>
<div id="ref-pearl2022direct" class="csl-entry" role="listitem">
———. 2022. <span>“Direct and Indirect Effects.”</span> In <em>Probabilistic and Causal Inference: The Works of Judea Pearl</em>, 1st ed., 373–92. New York, NY, USA: Association for Computing Machinery. <a href="https://doi.org/10.1145/3501714.3501736">https://doi.org/10.1145/3501714.3501736</a>.
</div>
<div id="ref-poirier_revising_1998" class="csl-entry" role="listitem">
Poirier, Dale J. 1998. <span>“Revising <span>Beliefs</span> in <span>Nonidentified</span> <span>Models</span>.”</span> <em>Econometric Theory</em> 14 (4): 483–509. <a href="https://doi.org/10.1017/S0266466698144043">https://doi.org/10.1017/S0266466698144043</a>.
</div>
<div id="ref-richardson2011transparent" class="csl-entry" role="listitem">
Richardson, Thomas S, Robin J Evans, and James M Robins. 2011. <span>“Transparent Parameterizations of Models for Potential Outcomes.”</span> <em>Bayesian Statistics</em> 9: 569–610.
</div>
<div id="ref-sachs_general_2023" class="csl-entry" role="listitem">
Sachs, Michael C., Gustav Jonzon, Arvid Sjölander, and Erin E. Gabriel. 2023. <span>“A <span>General</span> <span>Method</span> for <span>Deriving</span> <span>Tight</span> <span>Symbolic</span> <span>Bounds</span> on <span>Causal</span> <span>Effects</span>.”</span> <em>Journal of Computational and Graphical Statistics</em> 32 (2): 567–76. <a href="https://doi.org/10.1080/10618600.2022.2071905">https://doi.org/10.1080/10618600.2022.2071905</a>.
</div>
<div id="ref-dowhy" class="csl-entry" role="listitem">
Sharma, Amit, and Emre Kiciman. 2020. <span>“DoWhy: An End-to-End Library for Causal Inference.”</span> <em>arXiv Preprint arXiv:2011.04216</em>.
</div>
<div id="ref-textor_robust_2016" class="csl-entry" role="listitem">
Textor, Johannes, Benito van der Zander, Mark S Gilthorpe, Maciej Liśkiewicz, and George TH Ellison. 2016. <span>“Robust <span>Causal</span> <span>Inference</span> <span>Using</span> <span>Directed</span> <span>Acyclic</span> <span>Graphs</span>: The <span>Package</span> .”</span> <em>International Journal of Epidemiology</em> 45 (6): 1887–94. <a href="https://doi.org/10.1093/ije/dyw341">https://doi.org/10.1093/ije/dyw341</a>.
</div>
<div id="ref-zhang_partial_2022" class="csl-entry" role="listitem">
Zhang, Junzhe, Jin Tian, and Elias Bareinboim. 2022. <span>“Partial <span>Counterfactual</span> <span>Identification</span> from <span>Observational</span> and <span>Experimental</span> <span>Data</span>.”</span> In <em>Proceedings of the 39th <span>International</span> <span>Conference</span> on <span>Machine</span> <span>Learning</span></em>, 26548–58. PMLR. <a href="https://proceedings.mlr.press/v162/zhang22ab.html">https://proceedings.mlr.press/v162/zhang22ab.html</a>.
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="sec-parallel" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-parallel">Appendix A: Parallelization</h2>
<p>If users have access to multiple cores, parallel processing can be implemented by including this line before running <span class="pkg">CausalQueries</span>:</p>
<p>Additionally, parallelizing across models or data while running MCMC chains in parallel can be achieved by setting up a nested parallel process. With 8 cores one can run two updating processes with three parallel chains each simultaneously. More generally the number of parallel processes at the upper level of the nested parallel structure are given by <span class="math inline">\(\left \lfloor \frac{cores}{chains + 1} \right \rfloor\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"future"</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"future.apply"</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>chains <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>future<span class="sc">::</span><span class="fu">plan</span>(<span class="fu">list</span>(</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  future<span class="sc">::</span><span class="fu">tweak</span>(future<span class="sc">::</span>multisession, </span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">workers =</span> <span class="fu">floor</span>(cores<span class="sc">/</span>(chains <span class="sc">+</span> <span class="dv">1</span>))),</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  future<span class="sc">::</span><span class="fu">tweak</span>(future<span class="sc">::</span>multisession, <span class="at">workers =</span> chains)))</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">make_model</span>(<span class="st">"X -&gt; Y"</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">data_1 =</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>), </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_2 =</span> <span class="fu">data.frame</span>(<span class="at">X =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>))</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> future.apply<span class="sc">::</span><span class="fu">future_lapply</span>(data, <span class="cf">function</span>(d) {</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(<span class="at">model =</span> model, <span class="at">data =</span> d, <span class="at">chains =</span> chains, <span class="at">refresh =</span> <span class="dv">0</span>)},</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a> <span class="at">future.seed =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="sec-stancode" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-stancode">Appendix B: Stan code</h2>
<p>Updating is performed using a generic Stan model. The data provided to Stan is generated by the internal function <code>prep_stan_data()</code>, which returns a list of objects that Stan expects to receive. The code for the Stan model is shown below. After defining a helper function, the code starts with a block declaring what input data is to be expected. Then, the parameters and the transformed parameters are characterized. Then, the likelihoods and priors are provided. At the end, a block for generated quantities is used to append a posterior distribution of causal types to the model.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>S4 class stanmodel 'simplexes' coded as follows:
functions {
  row_vector col_sums(matrix X) {
    row_vector[cols(X)] s;
    s = rep_row_vector(1, rows(X)) * X;
    return s;
  }
}
data {
  int&lt;lower=1&gt; n_params;
  int&lt;lower=1&gt; n_paths;
  int&lt;lower=1&gt; n_types;
  int&lt;lower=1&gt; n_param_sets;
  int&lt;lower=1&gt; n_nodes;
  array[n_param_sets] int&lt;lower=1&gt; n_param_each;
  int&lt;lower=1&gt; n_data;
  int&lt;lower=1&gt; n_events;
  int&lt;lower=1&gt; n_strategies;
  int&lt;lower=0, upper=1&gt; keep_type_distribution;
  vector&lt;lower=0&gt;[n_params] lambdas_prior;
  array[n_param_sets] int&lt;lower=1&gt; l_starts;
  array[n_param_sets] int&lt;lower=1&gt; l_ends;
  array[n_nodes] int&lt;lower=1&gt; node_starts;
  array[n_nodes] int&lt;lower=1&gt; node_ends;
  array[n_strategies] int&lt;lower=1&gt; strategy_starts;
  array[n_strategies] int&lt;lower=1&gt; strategy_ends;
  matrix[n_params, n_types] P;
  matrix[n_params, n_paths] parmap;
  matrix[n_paths, n_data] map;
  matrix&lt;lower=0, upper=1&gt;[n_events, n_data] E;
  array[n_events] int&lt;lower=0&gt; Y;
}
parameters {
  vector&lt;lower=0&gt;[n_params - n_param_sets] gamma;
}
transformed parameters {
  vector&lt;lower=0, upper=1&gt;[n_params] lambdas;
  vector&lt;lower=1&gt;[n_param_sets] sum_gammas;
  matrix[n_params, n_paths] parlam;
  matrix[n_nodes, n_paths] parlam2;
  vector&lt;lower=0, upper=1&gt;[n_paths] w_0;
  vector&lt;lower=0, upper=1&gt;[n_data] w;
  vector&lt;lower=0, upper=1&gt;[n_events] w_full;
  vector[n_param_sets] log_sum_gammas;
  // Handle cases where parameter set has only one value
  for (i in 1:n_param_sets) {
    if (l_starts[i] &gt;= l_ends[i]) {
      sum_gammas[i] = 1;
      lambdas[l_starts[i]] = 1;
    } else {
      sum_gammas[i] = 1 + sum(gamma[(l_starts[i] - (i - 1)):(l_ends[i] - i)]);
      lambdas[l_starts[i]:l_ends[i]] =
        append_row(1, gamma[(l_starts[i] - (i - 1)):(l_ends[i] - i)]) /
        sum_gammas[i];
    }
  }
  // Mapping from parameters to data types
  parlam = rep_matrix(lambdas, n_paths) .* parmap;
  // Sum probability over nodes on each path
  for (i in 1:n_nodes) {
    parlam2[i, ] = col_sums(parlam[(node_starts[i]):(node_ends[i]), ]);
  }
  // Compute probability of data type on each path
  for (i in 1:n_paths) {
    w_0[i] = exp(sum(log(parlam2[, i])));
  }
  // Map to n_data columns instead of n_paths (if confounding)
  w = map' * w_0;
  // Extend/reduce to cover all observed data types
  w_full = E * w;
  // Calculate log sum gammas once for efficiency
  log_sum_gammas = log(sum_gammas);
}
model {
  // Dirichlet distributions
  for (i in 1:n_param_sets) {
    target += dirichlet_lpdf(lambdas[l_starts[i]:l_ends[i]] |
                             lambdas_prior[l_starts[i]:l_ends[i]]);
    target += -n_param_each[i] * log_sum_gammas[i];
  }
  // Multinomial likelihoods (handling censoring)
  for (i in 1:n_strategies) {
    target += multinomial_lpmf(
      Y[strategy_starts[i]:strategy_ends[i]] |
      w_full[strategy_starts[i]:strategy_ends[i]] /
      sum(w_full[strategy_starts[i]:strategy_ends[i]])
    );
  }
}
// Option to export distribution of causal types
generated quantities {
  vector[n_types] types;
  if (keep_type_distribution == 1) {
    for (i in 1:n_types) {
      types[i] = prod(P[, i] .* lambdas + 1 - P[, i]);
    }
  } else {
    types = rep_vector(1, n_types);
  }
} </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="sec-benchmark" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sec-benchmark">Appendix C: Benchmarks</h2>
<p>We present a brief summary of model updating benchmarks. Note that these benchmarks are not generally reproducible and depend on the specifications of the hardware system used to produce them. The first benchmark considers the effect of model complexity on updating time. The second benchmark considers the effect of data size on updating time. We run four parallel chains for each model with a relatively large number (4000) of iterations each time, all replicated eight times. The results of the benchmarks are presented in <a href="#tbl-bench1" class="quarto-xref">Table&nbsp;8</a> and <a href="#tbl-bench2" class="quarto-xref">Table&nbsp;9</a>.</p>
<p>Increasing the number of parents in a model greatly increases the number of parameters and computational time. The results suggests the computational time is convex in the number of parents. Unless model restrictions are imposed, four parents would yield 65,536 parameters. The rapid growth of the parameter space with increasing model complexity places limits on feasible computability without further recourse to specialized methods for handling large causal models. In contrast, the results suggest that computational time is concave in the size of the data.</p>
<div class="cell">
<div id="tbl-bench1" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bench1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8: Benchmarking 1.
</figcaption>
<div aria-describedby="tbl-bench1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Number of parameters</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Runtime (seconds)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">X1 → Y</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">6.31</td>
</tr>
<tr class="even">
<td style="text-align: center;">X1 → Y; X2 → Y</td>
<td style="text-align: center;">20</td>
<td style="text-align: center;">5.65</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X1 → Y; X2 → Y; X3 → Y</td>
<td style="text-align: center;">262</td>
<td style="text-align: center;">42.15</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div id="tbl-bench2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-bench2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;9: Benchmarking 2.
</figcaption>
<div aria-describedby="tbl-bench2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="lightable-classic-2 do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Number of observations</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Runtime (seconds)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">X1 → Y</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">6.19</td>
</tr>
<tr class="even">
<td style="text-align: center;">X1 → Y</td>
<td style="text-align: center;">100</td>
<td style="text-align: center;">5.17</td>
</tr>
<tr class="odd">
<td style="text-align: center;">X1 → Y</td>
<td style="text-align: center;">1000</td>
<td style="text-align: center;">5.39</td>
</tr>
<tr class="even">
<td style="text-align: center;">X1 → Y</td>
<td style="text-align: center;">10000</td>
<td style="text-align: center;">4.45</td>
</tr>
</tbody>
</table>


</div>
</div>
</figure>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Note that the “using” column is omitted to simplify output, as all estimands are derived from the posterior distribution.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See Section 9.4.1 of <span class="citation" data-cites="humphreys_integrated_2023">Humphreys and Jacobs (<a href="#ref-humphreys_integrated_2023" role="doc-biblioref">2023</a>)</span> for a method that represents non-binary data as a profile of outcomes on multiple binary nodes.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>A similar approach may be used for non binary nodes though in this case the index components can take on more values and then length of indices adjust to reflect the set of all possible parent value combinations.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>While flexible, using the Dirichlet distribution does constrain the types of priors that can be represented; see <span class="citation" data-cites="irons2023causally">Irons and Cinelli (<a href="#ref-irons2023causally" role="doc-biblioref">2023</a>)</span> for a discussion of these constraints and an approach to incorporating richer priors using multiple Beta distributions.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>If there is confounding in the model, priors are specified over the conditional distribution of nodal types.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Users can specify beliefs about <span class="math inline">\(\lambda^Y\)</span> given <span class="math inline">\(\theta^X\)</span> if a model involves possible confounding. However, this refers to beliefs over a joint distribution, not jointly distributed beliefs.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Note that <code>NA</code>’s are interpreted as data not being sought.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>For further discussion, see Section 9.2.3.2 in <span class="citation" data-cites="humphreys_integrated_2023">Humphreys and Jacobs (<a href="#ref-humphreys_integrated_2023" role="doc-biblioref">2023</a>)</span>.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>See <a href="https://mc-stan.org/cmdstanr/reference/fit-method-lp.html">Stan documentation</a> for more details.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p><span class="pkg">CausalQueries</span> also accepts <code>=</code> as a shorthand for <code>==</code>, but <code>==</code> is preferred as it is the standard logical operator.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>